<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>分类: Android源码 - onlyloveyd</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="小码过河，人人喊累">
<meta name="keywords" content="onlyloveyd">
<meta property="og:type" content="website">
<meta property="og:title" content="onlyloveyd">
<meta property="og:url" content="http://yoursite.com/categories/Android源码/index.html">
<meta property="og:site_name" content="onlyloveyd">
<meta property="og:description" content="小码过河，人人喊累">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="onlyloveyd">
<meta name="twitter:description" content="小码过河，人人喊累">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="onlyloveyd" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/categories">分类</a></li>
            
            <li class="is-active"><a href="#" aria-current="page">Android源码</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-09-23T15:23:28.000Z">2017-09-23</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 分钟 读完 (大约 212 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/09/23/《Android 源码分析（0）》 Android 8.0 源码下载编译/">《Android 源码分析（0）》 Android 8.0 源码下载编译</a>
            
        </h1>
        <div class="content">
            <h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a><a href></a>1. 介绍</h2><p> 最近打算利用工作之余，学习Android源码。自从开始接触应用开发之后，这一块就一直被忽略了。今天从Ubuntu系统安装开始，到Android8.0的代码编译完成，参照别人的经验，过程还算比较顺利。</p>
<h2 id="2-步骤"><a href="#2-步骤" class="headerlink" title="2. 步骤"></a><a href></a>2. 步骤</h2><p> 参考官网文档：<br> <a href="https://source.android.com/source/initializing" target="_blank" rel="noopener">https://source.android.com/source/initializing</a><br> 或者博文：<br> <a href="http://www.jianshu.com/p/367f0886e62b" target="_blank" rel="noopener">http://www.jianshu.com/p/367f0886e62b</a><br> 基本上依照这篇博文，基本上就可以在Ubuntu环境下快速的完成Android源码的下载和编译。注意切换分支到自己想要的branch上。</p>
<h2 id="3-编译结果"><a href="#3-编译结果" class="headerlink" title="3. 编译结果"></a><a href></a>3. 编译结果</h2><p> <img src="https://img-blog.csdn.net/20170923232321205?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcG9vcmtpY2s=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-09-13T09:20:08.000Z">2016-09-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分钟 读完 (大约 1563 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2016/09/13/《Android Framework 之路》 N版本 Framework Camera的一些改动/">《Android Framework 之路》 N版本 Framework Camera的一些改动</a>
            
        </h1>
        <div class="content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Android N版本最近发布，Nougat是否好吃，不得而知，慢慢看下~  
感谢<a href="http://androidxref.com/7.0.0_r1/" target="_blank" rel="noopener">AndroidXref</a>这个网站，给开发者提供了大量的便捷~以后学习Android就靠它了。</p>
<h2 id="N版本上Framework关于Camera的一些改动"><a href="#N版本上Framework关于Camera的一些改动" class="headerlink" title="N版本上Framework关于Camera的一些改动"></a>N版本上Framework关于Camera的一些改动</h2><h3 id="CameraServer"><a href="#CameraServer" class="headerlink" title="CameraServer"></a>CameraServer</h3><p> N版本之前，CameraService是运行在MediaServer下的，这样存在一定的问题，因为MediaServer下同时还运行这其他的多媒体内容<br> M版本</p>
<p> /frameworks/av/media/mediaserver/main_mediaserver.cpp</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc __unused, <span class="hljs-keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    <span class="hljs-keyword">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="hljs-keyword">bool</span> doLog = (property_get(<span class="hljs-string">"ro.test_harness"</span>, value, <span class="hljs-string">"0"</span>) &gt; <span class="hljs-number">0</span>) &amp;&amp; (atoi(value) == <span class="hljs-number">1</span>);</span><br><span class="line">    <span class="hljs-keyword">pid_t</span> childPid;</span><br><span class="line">    <span class="hljs-comment">// FIXME The advantage of making the process containing media.log service the parent process of</span></span><br><span class="line">    <span class="hljs-comment">// the process that contains all the other real services, is that it allows us to collect more</span></span><br><span class="line">    <span class="hljs-comment">// detailed information such as signal numbers, stop and continue, resource usage, etc.</span></span><br><span class="line">    <span class="hljs-comment">// But it is also more complex.  Consider replacing this by independent processes, and using</span></span><br><span class="line">    <span class="hljs-comment">// binder on death notification instead.</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (doLog &amp;&amp; (childPid = fork()) != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">// media.log service</span></span><br><span class="line">        <span class="hljs-comment">//prctl(PR_SET_NAME, (unsigned long) "media.log", 0, 0, 0);</span></span><br><span class="line">        <span class="hljs-comment">// unfortunately ps ignores PR_SET_NAME for the main thread, so use this ugly hack</span></span><br><span class="line">        <span class="hljs-built_in">strcpy</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">"media.log"</span>);</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        MediaLogService::instantiate();</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">        <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="hljs-keyword">siginfo_t</span> info;</span><br><span class="line">            <span class="hljs-keyword">int</span> ret = waitid(P_PID, childPid, &amp;info, WEXITED | WSTOPPED | WCONTINUED);</span><br><span class="line">            <span class="hljs-keyword">if</span> (ret == EINTR) &#123;</span><br><span class="line">                <span class="hljs-keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">32</span>];</span><br><span class="line">            <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *code;</span><br><span class="line">            <span class="hljs-keyword">switch</span> (info.si_code) &#123;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_EXITED:</span><br><span class="line">                code = <span class="hljs-string">"CLD_EXITED"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_KILLED:</span><br><span class="line">                code = <span class="hljs-string">"CLD_KILLED"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_DUMPED:</span><br><span class="line">                code = <span class="hljs-string">"CLD_DUMPED"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_STOPPED:</span><br><span class="line">                code = <span class="hljs-string">"CLD_STOPPED"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_TRAPPED:</span><br><span class="line">                code = <span class="hljs-string">"CLD_TRAPPED"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_CONTINUED:</span><br><span class="line">                code = <span class="hljs-string">"CLD_CONTINUED"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">default</span>:</span><br><span class="line">                <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-keyword">sizeof</span>(buffer), <span class="hljs-string">"unknown (%d)"</span>, info.si_code);</span><br><span class="line">                code = buffer;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rusage</span> <span class="hljs-title">usage</span>;</span></span><br><span class="line">            getrusage(RUSAGE_CHILDREN, &amp;usage);</span><br><span class="line">            ALOG(LOG_ERROR, <span class="hljs-string">"media.log"</span>, <span class="hljs-string">"pid %d status %d code %s user %ld.%03lds sys %ld.%03lds"</span>,</span><br><span class="line">                    info.si_pid, info.si_status, code,</span><br><span class="line">                    usage.ru_utime.tv_sec, usage.ru_utime.tv_usec / <span class="hljs-number">1000</span>,</span><br><span class="line">                    usage.ru_stime.tv_sec, usage.ru_stime.tv_usec / <span class="hljs-number">1000</span>);</span><br><span class="line">            sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">            sp&lt;IBinder&gt; binder = sm-&gt;getService(String16(<span class="hljs-string">"media.log"</span>));</span><br><span class="line">            <span class="hljs-keyword">if</span> (binder != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                Vector&lt;String16&gt; args;</span><br><span class="line">                binder-&gt;dump(<span class="hljs-number">-1</span>, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">switch</span> (info.si_code) &#123;</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_EXITED:</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_KILLED:</span><br><span class="line">            <span class="hljs-keyword">case</span> CLD_DUMPED: &#123;</span><br><span class="line">                ALOG(LOG_INFO, <span class="hljs-string">"media.log"</span>, <span class="hljs-string">"exiting"</span>);</span><br><span class="line">                _exit(<span class="hljs-number">0</span>);</span><br><span class="line">                <span class="hljs-comment">// not reached</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="hljs-keyword">default</span>:</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// all other services</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (doLog) &#123;</span><br><span class="line">            prctl(PR_SET_PDEATHSIG, SIGKILL);   <span class="hljs-comment">// if parent media.log dies before me, kill me also</span></span><br><span class="line">            setpgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);                      <span class="hljs-comment">// but if I die first, don't kill my parent</span></span><br><span class="line">        &#125;</span><br><span class="line">        InitializeIcuOrDie();</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">        ALOGI(<span class="hljs-string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">        AudioFlinger::instantiate();</span><br><span class="line">        MediaPlayerService::instantiate();</span><br><span class="line">        ResourceManagerService::instantiate();</span><br><span class="line">        CameraService::instantiate();</span><br><span class="line">        AudioPolicyService::instantiate();</span><br><span class="line">        SoundTriggerHwService::instantiate();</span><br><span class="line">        RadioService::instantiate();</span><br><span class="line">        registerExtensions();</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到AudioFlinger，MediaPlayerService, ResourceManagerService,CameraService,AudioPolicyService,SoundTriggerHwService,RadioService等都是运行在这个进程下面的，这样就存在一个问题，假如说其他任何一个服务因为某些原因挂掉了，整个MediaServer将会重启，而这个重启的过程中，倘若相机正在操作，就会出现相机突然挂掉的问题。</p>
<p> N版本<br> /frameworks/av/media/mediaserver/main_mediaserver.cpp</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc __unused, <span class="hljs-keyword">char</span> **argv __unused)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    sp&lt;IServiceManager&gt; sm(defaultServiceManager());</span><br><span class="line">    ALOGI(<span class="hljs-string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">    InitializeIcuOrDie();</span><br><span class="line">    MediaPlayerService::instantiate();</span><br><span class="line">    ResourceManagerService::instantiate();</span><br><span class="line">    registerExtensions();</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有没有觉得少了很多，不仅CameraService被抽离出去了，还有一些内容好像也被抽离出去了。<br>在N版本的工程中多出来一个文件夹<br>/frameworks/av/camera/cameraserver/<br><img src="https://img-blog.csdn.net/20160913163509896" alt="这里写图片描述"><br>说明CameraServer是独立于MediaServer的单独的进程，执行PS操作你讲看到独立的Camera进程。</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOG_TAG <span class="hljs-meta-string">"cameraserver"</span></span></span><br><span class="line"><span class="hljs-comment">//#define LOG_NDEBUG 0</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// from LOCAL_C_INCLUDES</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"CameraService.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc __unused, <span class="hljs-keyword">char</span>** argv __unused)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ALOGI(<span class="hljs-string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">    CameraService::instantiate();</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化的过程并没有变化，只是单纯的将它独立出来而已。<br>那么问题来了，CameraService何时启动？<br>看到cameraserver.rc文件，</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">service cameraserver /system/bin/cameraserver</span><br><span class="line">    class main</span><br><span class="line">    user cameraserver</span><br><span class="line">    group audio camera drmrpc inet media mediadrm net_bt net_bt_admin net_bw_acct</span><br><span class="line">    ioprio rt 4</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>

<p>也就是说只要加载了cameraserver.rc文件，服务就开始启动了，就会往main_cameraserer.cpp的入口函数中执行，因为mk文件中定义了这个模块为cameraserver</p>
<figure class="highlight mk hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="hljs-variable">$(<span class="hljs-built_in">call</span> my-<span class="hljs-built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">include</span> <span class="hljs-variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES:= \</span><br><span class="line">    main_cameraserver.cpp//源文件</span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES := \//依赖库</span><br><span class="line">    libcameraservice \</span><br><span class="line">    libcutils \</span><br><span class="line">    libutils \</span><br><span class="line">    libbinder \</span><br><span class="line">    libcamera_client</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE:= cameraserver//模块名</span><br><span class="line">LOCAL_32_BIT_ONLY := true//只支持32位</span><br><span class="line"></span><br><span class="line">LOCAL_CFLAGS += -Wall -Wextra -Werror -Wno-unused-parameter//一些编译条件，N版本在编译这一块也作出了很大的改动，有机会再研究下</span><br><span class="line"></span><br><span class="line">LOCAL_INIT_RC := cameraserver.rc</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">include</span> <span class="hljs-variable">$(BUILD_EXECUTABLE)</span>//执行文件</span><br></pre></td></tr></table></figure>

<p>寻找，谁调用的camearserver.rc ???<br>首先我们要看这个文件编译出来之后放在手机的什么位置<br>/build/core/base_rules.mk</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Rule to install the module&apos;s companion init.rc.</span><br><span class="line">my_init_rc := $(LOCAL_INIT_RC_$(my_32_64_bit_suffix))</span><br><span class="line">my_init_rc_src :=</span><br><span class="line">my_init_rc_installed :=</span><br><span class="line">ifndef my_init_rc</span><br><span class="line">my_init_rc := $(LOCAL_INIT_RC)</span><br><span class="line"># Make sure we don&apos;t define the rule twice in multilib module.</span><br><span class="line">LOCAL_INIT_RC :=</span><br><span class="line">endif</span><br><span class="line">ifdef my_init_rc</span><br><span class="line">my_init_rc_src := $(LOCAL_PATH)/$(my_init_rc)</span><br><span class="line">my_init_rc_installed := $(TARGET_OUT$(partition_tag)_ETC)/init/$(notdir $(my_init_rc_src))</span><br><span class="line">$(my_init_rc_installed) : $(my_init_rc_src) | $(ACP)</span><br><span class="line">    @echo &quot;Install: $@&quot;</span><br><span class="line">    $(copy-file-to-new-target)</span><br><span class="line"></span><br><span class="line">$(my_register_name) : $(my_init_rc_installed)</span><br></pre></td></tr></table></figure>

<p>大致可以看出一些端倪，应该是放在xxx/etc/init目录下，这个xxx根据什么看判断，partition_tag变量</p>
<figure class="highlight mk hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">ifdef</span> LOCAL_IS_HOST_MODULE</span><br><span class="line">  partition_tag :=</span><br><span class="line"><span class="hljs-keyword">else</span></span><br><span class="line"><span class="hljs-keyword">ifeq</span> (true,<span class="hljs-variable">$(LOCAL_PROPRIETARY_MODULE)</span>)</span><br><span class="line">  partition_tag := _VENDOR</span><br><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">ifeq</span> (true,<span class="hljs-variable">$(LOCAL_OEM_MODULE)</span>)</span><br><span class="line">  partition_tag := _OEM</span><br><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">ifeq</span> (true,<span class="hljs-variable">$(LOCAL_ODM_MODULE)</span>)</span><br><span class="line">  partition_tag := _ODM</span><br><span class="line"><span class="hljs-keyword">else</span></span><br><span class="line">  <span class="hljs-comment"># The definition of should-install-to-system will be different depending</span></span><br><span class="line">  <span class="hljs-comment"># on which goal (e.g., sdk or just droid) is being built.</span></span><br><span class="line">  partition_tag := <span class="hljs-variable">$(<span class="hljs-built_in">if</span> $(<span class="hljs-built_in">call</span> should-install-to-system,<span class="hljs-variable">$(my_module_tags)</span>)</span>,,_DATA)</span><br><span class="line"><span class="hljs-keyword">endif</span></span><br></pre></td></tr></table></figure>

<p>cameraserver应该是系统所有的，不是oem或者odm特有，存放在system/etc/init目录下。<br>接下面看看这个文件<br>/system/core/init/readme.txt</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">One may specify paths in the mount_all command line to have it import</span><br><span class="line">.rc files at the specified paths instead of the default ones listed above.</span><br><span class="line">This is primarily for supporting factory mode and other non-standard boot</span><br><span class="line">modes.  The three default paths should be used for the normal boot process.</span><br><span class="line"></span><br><span class="line">The intention of these directories is as follows</span><br><span class="line">   1) /system/etc/init/ is for core system items such as</span><br><span class="line">      SurfaceFlinger, MediaService, and logcatd.</span><br><span class="line">   2) /vendor/etc/init/ is for SoC vendor items such as actions or</span><br><span class="line">      daemons needed for core SoC functionality.</span><br><span class="line">   3) /odm/etc/init/ is for device manufacturer items such as</span><br><span class="line">      actions or daemons needed for motion sensor or other peripheral</span><br><span class="line">      functionality.</span><br></pre></td></tr></table></figure>

<p>显然是在执行“mount_all“的时候，CameraServer启动 ~ ，找到启动的位置，这一点和之前的版本是有很大差别的。</p>
<h3 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h3><p>N版本上对于Camera的一些接口采用了Aidl的文件格式<br>frameworks/av/camera/aidl/android/hardware/<br><img src="https://img-blog.csdn.net/20160913171230808" alt="这里写图片描述"></p>
<p>其他模块想要访问这些接口，需要include libcamera_client模块才行</p>
<p><img src="https://img-blog.csdn.net/20160913171436512" alt="这里写图片描述"></p>
<p>mk文件中有说明。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-08-10T00:05:49.000Z">2016-08-10</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    16 分钟 读完 (大约 2340 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2016/08/10/《Android Framework 之路》BootAnimation（2）/">《Android Framework 之路》BootAnimation（2）</a>
            
        </h1>
        <div class="content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p> 上一篇主要讲解了BootAnimation是从何而来，如何启动，从开机，到SurfaceFlinger服务起来，然后到执行开机动画，如果要深入的看里面的代码，是需要花一定的时间的，我们旨在了解大致的流程，具体流程中的函数，变量意义，具体实现，读者请自研。<br> 由来已知，执行待述~</p>
<h2 id="BootAnimation执行"><a href="#BootAnimation执行" class="headerlink" title="BootAnimation执行"></a>BootAnimation执行</h2><h3 id="代码位置"><a href="#代码位置" class="headerlink" title="代码位置"></a>代码位置</h3><pre><code>frameworks/base/cmds/bootanimation  
目录中包含如下文件  
![这里写图片描述](https://img-blog.csdn.net/20160808125603638)  
|文件名|作用|  
|----|----|  
|Android.mk|mk文件，编译模块使用|  
|AudioPlayer.cpp、AudioPlayer.h|音频播放|  
|BootAnimation.cpp、BootAnimation.h|开机动画的源文件和头文件|  
|bootanimation_main.cpp|开机动画的入口|  </code></pre><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><pre><code>bootanimation_main.cpp  
文件中定义main函数，也就是C语言中的执行文件的入口函数  </code></pre><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv)</span><br><span class="line">&#123;</span><br><span class="line">//宏定义判断是否设置进程的优先级</span><br><span class="line">#if defined(HAVE_PTHREADS)</span><br><span class="line">    setpriority(PRIO_PROCESS, 0, ANDROID_PRIORITY_DISPLAY);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    char value[PROPERTY_VALUE_MAX];</span><br><span class="line">    //这个配置项决定是否存在开机动画</span><br><span class="line">    property_get(&quot;debug.sf.nobootanimation&quot;, value, &quot;0&quot;);</span><br><span class="line">    int noBootAnimation = atoi(value);</span><br><span class="line">    ALOGI_IF(noBootAnimation,  &quot;boot animation disabled&quot;);</span><br><span class="line">    if (!noBootAnimation) &#123;</span><br><span class="line">        //创建ProcessSate对象</span><br><span class="line">        // 这个过程会打开/dev/binder设备，形成和内核binder机制的交互的通道; 映射fd到内存</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        //创建线程并加入到线程池</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        // 创建开机动画对象</span><br><span class="line">        sp&lt;BootAnimation&gt; boot = new BootAnimation();</span><br><span class="line">	    //把主线程加入到线程池</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 创建开机动画对象会执行到BootAnimation的构造方法，先看下BootAnimation的头文件<br> BootAnimation.h</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">namespace android &#123;</span><br><span class="line"></span><br><span class="line">class AudioPlayer;</span><br><span class="line">class Surface;</span><br><span class="line">class SurfaceComposerClient;</span><br><span class="line">class SurfaceControl;</span><br><span class="line"></span><br><span class="line">// ---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">class BootAnimation : public Thread, public IBinder::DeathRecipient</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">                BootAnimation();</span><br><span class="line">    virtual     ~BootAnimation();</span><br><span class="line"></span><br><span class="line">    sp&lt;SurfaceComposerClient&gt; session() const;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">   virtual bool        threadLoop();</span><br><span class="line">   virtual status_t    readyToRun();</span><br><span class="line">   virtual void        onFirstRef();</span><br><span class="line">   virtual void        binderDied(const wp&lt;IBinder&gt;&amp; who);</span><br><span class="line"></span><br><span class="line">   //Texture类定义</span><br><span class="line">   struct Texture &#123;</span><br><span class="line">       GLint   w; //宽度</span><br><span class="line">       GLint   h; //高度</span><br><span class="line">       GLuint  name; //名称</span><br><span class="line">   &#125;;</span><br><span class="line">   //动画内容结构体</span><br><span class="line">   struct Animation &#123;</span><br><span class="line">       //动画帧</span><br><span class="line">       struct Frame &#123;</span><br><span class="line">           String8 name;</span><br><span class="line">           FileMap* map;</span><br><span class="line">           mutable GLuint tid;</span><br><span class="line">           bool operator &lt; (const Frame&amp; rhs) const &#123;</span><br><span class="line">               return name &lt; rhs.name;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       //动画部分，因为动画可能是由几个部分组成</span><br><span class="line">       struct Part &#123;</span><br><span class="line">           int count;</span><br><span class="line">           int pause;</span><br><span class="line">           String8 path;</span><br><span class="line">           SortedVector&lt;Frame&gt; frames;</span><br><span class="line">           bool playUntilComplete;</span><br><span class="line">           float backgroundColor[3];</span><br><span class="line">           FileMap* audioFile;</span><br><span class="line">       &#125;;</span><br><span class="line">       int fps;</span><br><span class="line">       int width;</span><br><span class="line">       int height;</span><br><span class="line">       Vector&lt;Part&gt; parts;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   status_t initTexture(Texture* texture, AssetManager&amp; asset, const char* name);</span><br><span class="line">   status_t initTexture(const Animation::Frame&amp; frame);</span><br><span class="line">   bool android();</span><br><span class="line">   bool readFile(const char* name, String8&amp; outString);</span><br><span class="line">   bool movie();</span><br><span class="line"></span><br><span class="line">   void checkExit();</span><br><span class="line"></span><br><span class="line">   sp&lt;SurfaceComposerClient&gt;       mSession;</span><br><span class="line">   sp&lt;AudioPlayer&gt;                 mAudioPlayer;</span><br><span class="line">   AssetManager mAssets;</span><br><span class="line">   Texture     mAndroid[2];</span><br><span class="line">   int         mWidth;</span><br><span class="line">   int         mHeight;</span><br><span class="line">   EGLDisplay  mDisplay;</span><br><span class="line">   EGLDisplay  mContext;</span><br><span class="line">   EGLDisplay  mSurface;</span><br><span class="line">   sp&lt;SurfaceControl&gt; mFlingerSurfaceControl;</span><br><span class="line">   sp&lt;Surface&gt; mFlingerSurface;</span><br><span class="line">   ZipFileRO   *mZip;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">&#125;; // namespace android</span><br><span class="line"></span><br><span class="line">#endif // ANDROID_BOOTANIMATION_H</span><br></pre></td></tr></table></figure>

<p> 大致的定义和声明就是这么多，看下具体实现<br> BootAnimation.cpp<br> 首先执行构造方法</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BootAnimation::BootAnimation() : Thread(false), mZip(NULL)</span><br><span class="line">&#123;</span><br><span class="line">	//用于界面显示的mSession，与SurfaceFlinger交互的客户端</span><br><span class="line">    mSession = new SurfaceComposerClient();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 然后执行</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::onFirstRef() &#123;</span><br><span class="line">    status_t err = mSession-&gt;linkToComposerDeath(this);</span><br><span class="line">    ALOGE_IF(err, &quot;linkToComposerDeath failed (%s) &quot;, strerror(-err));</span><br><span class="line">    if (err == NO_ERROR) &#123;</span><br><span class="line">        run(&quot;BootAnimation&quot;, PRIORITY_DISPLAY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 由于BootAnimation继承Thread类，首先会调用readyToRun函数</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">status_t BootAnimation::readyToRun() &#123;</span><br><span class="line">    mAssets.addDefaultAssets();</span><br><span class="line"></span><br><span class="line">    sp&lt;IBinder&gt; dtoken(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">            ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">    DisplayInfo dinfo;</span><br><span class="line">    status_t status = SurfaceComposerClient::getDisplayInfo(dtoken, &amp;dinfo);</span><br><span class="line">    if (status)</span><br><span class="line">        return -1;</span><br><span class="line"></span><br><span class="line">    // create the native surface</span><br><span class="line">    sp&lt;SurfaceControl&gt; control = session()-&gt;createSurface(String8(&quot;BootAnimation&quot;),</span><br><span class="line">            dinfo.w, dinfo.h, PIXEL_FORMAT_RGB_565);</span><br><span class="line"></span><br><span class="line">    SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line">    control-&gt;setLayer(0x40000000);</span><br><span class="line">    SurfaceComposerClient::closeGlobalTransaction();</span><br><span class="line"></span><br><span class="line">    sp&lt;Surface&gt; s = control-&gt;getSurface();</span><br><span class="line"></span><br><span class="line">    // initialize opengl and egl</span><br><span class="line">    const EGLint attribs[] = &#123;</span><br><span class="line">            EGL_RED_SIZE,   8,</span><br><span class="line">            EGL_GREEN_SIZE, 8,</span><br><span class="line">            EGL_BLUE_SIZE,  8,</span><br><span class="line">            EGL_DEPTH_SIZE, 0,</span><br><span class="line">            EGL_NONE</span><br><span class="line">    &#125;;</span><br><span class="line">    EGLint w, h, dummy;</span><br><span class="line">    EGLint numConfigs;</span><br><span class="line">    EGLConfig config;</span><br><span class="line">    EGLSurface surface;</span><br><span class="line">    EGLContext context;</span><br><span class="line"></span><br><span class="line">    EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    eglInitialize(display, 0, 0);</span><br><span class="line">    eglChooseConfig(display, attribs, &amp;config, 1, &amp;numConfigs);</span><br><span class="line">    surface = eglCreateWindowSurface(display, config, s.get(), NULL);</span><br><span class="line">    context = eglCreateContext(display, config, NULL, NULL);</span><br><span class="line">    eglQuerySurface(display, surface, EGL_WIDTH, &amp;w);</span><br><span class="line">    eglQuerySurface(display, surface, EGL_HEIGHT, &amp;h);</span><br><span class="line"></span><br><span class="line">    if (eglMakeCurrent(display, surface, surface, context) == EGL_FALSE)</span><br><span class="line">        return NO_INIT;</span><br><span class="line"></span><br><span class="line">    mDisplay = display;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mSurface = surface;</span><br><span class="line">    mWidth = w;</span><br><span class="line">    mHeight = h;</span><br><span class="line">    mFlingerSurfaceControl = control;</span><br><span class="line">    mFlingerSurface = s;</span><br><span class="line"></span><br><span class="line">    // If the device has encryption turned on or is in process</span><br><span class="line">    // of being encrypted we show the encrypted boot animation.</span><br><span class="line">    char decrypt[PROPERTY_VALUE_MAX];</span><br><span class="line">    property_get(&quot;vold.decrypt&quot;, decrypt, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">    bool encryptedAnimation = atoi(decrypt) != 0 || !strcmp(&quot;trigger_restart_min_framework&quot;, decrypt);</span><br><span class="line"></span><br><span class="line">    ZipFileRO* zipFile = NULL;</span><br><span class="line">    if ((encryptedAnimation &amp;&amp;</span><br><span class="line">            (access(SYSTEM_ENCRYPTED_BOOTANIMATION_FILE, R_OK) == 0) &amp;&amp;</span><br><span class="line">            ((zipFile = ZipFileRO::open(SYSTEM_ENCRYPTED_BOOTANIMATION_FILE)) != NULL)) ||</span><br><span class="line"></span><br><span class="line">            ((access(OEM_BOOTANIMATION_FILE, R_OK) == 0) &amp;&amp;</span><br><span class="line">            ((zipFile = ZipFileRO::open(OEM_BOOTANIMATION_FILE)) != NULL)) ||</span><br><span class="line"></span><br><span class="line">            ((access(SYSTEM_BOOTANIMATION_FILE, R_OK) == 0) &amp;&amp;</span><br><span class="line">            ((zipFile = ZipFileRO::open(SYSTEM_BOOTANIMATION_FILE)) != NULL))) &#123;</span><br><span class="line">        mZip = zipFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 上面主要做两个操作：</p>
<p>初始化显示界面用于播放开机动画，egl的一些内容；<br>根据手机是否加密选择不同的开机动画文件，然后拿到入口zipFile<br>其中用到了一个文件路径在BootAnimation.cpp的开头有定义  </p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define OEM_BOOTANIMATION_FILE &quot;/oem/media/bootanimation.zip&quot;   //这个应该是OEM厂商自己定制</span><br><span class="line"></span><br><span class="line">#define SYSTEM_BOOTANIMATION_FILE &quot;/system/media/bootanimation.zip&quot;   //正常情况下的Android原始开机动画</span><br><span class="line"></span><br><span class="line">#define SYSTEM_ENCRYPTED_BOOTANIMATION_FILE &quot;/system/media/bootanimation-encrypted.zip&quot; //加密手机的开机动画</span><br></pre></td></tr></table></figure>

<p> readyToRun方法执行完之后，接着看threaLoop函数</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::threadLoop()</span><br><span class="line">&#123;</span><br><span class="line">    bool r;</span><br><span class="line">    // We have no bootanimation file, so we use the stock android logo</span><br><span class="line">    // animation.</span><br><span class="line">    if (mZip == NULL) &#123;</span><br><span class="line">        r = android(); //没有开机动画文件，执行android logo</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        r = movie(); //存在开机动画文件，则执行对应的开机动画文件解析出来的内容</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    eglMakeCurrent(mDisplay, EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);</span><br><span class="line">    eglDestroyContext(mDisplay, mContext);</span><br><span class="line">    eglDestroySurface(mDisplay, mSurface);</span><br><span class="line">    mFlingerSurface.clear();</span><br><span class="line">    mFlingerSurfaceControl.clear();</span><br><span class="line">    eglTerminate(mDisplay);</span><br><span class="line">    IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    return r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ——————————————&gt;android()</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">bool BootAnimation::android()</span><br><span class="line">&#123;</span><br><span class="line">    //初始化两个纹理用于显示logo</span><br><span class="line">    initTexture(&amp;mAndroid[0], mAssets, &quot;images/android-logo-mask.png&quot;);</span><br><span class="line">    initTexture(&amp;mAndroid[1], mAssets, &quot;images/android-logo-shine.png&quot;);</span><br><span class="line"></span><br><span class="line">    // clear screen 清屏</span><br><span class="line">    glShadeModel(GL_FLAT);</span><br><span class="line">    glDisable(GL_DITHER);</span><br><span class="line">    glDisable(GL_SCISSOR_TEST);</span><br><span class="line">    glClearColor(0,0,0,1);</span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">    eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line"></span><br><span class="line">    glEnable(GL_TEXTURE_2D);</span><br><span class="line">    glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line"></span><br><span class="line">    const GLint xc = (mWidth  - mAndroid[0].w) / 2;</span><br><span class="line">    const GLint yc = (mHeight - mAndroid[0].h) / 2;</span><br><span class="line">    const Rect updateRect(xc, yc, xc + mAndroid[0].w, yc + mAndroid[0].h);</span><br><span class="line"></span><br><span class="line">    glScissor(updateRect.left, mHeight - updateRect.bottom, updateRect.width(),</span><br><span class="line">            updateRect.height());</span><br><span class="line"></span><br><span class="line">    // Blend state</span><br><span class="line">    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">    glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line"></span><br><span class="line">    const nsecs_t startTime = systemTime();</span><br><span class="line">    //不停的显示知道exitPending()返回true</span><br><span class="line">    do &#123;</span><br><span class="line">        ......</span><br><span class="line">        EGLBoolean res = eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        checkExit();</span><br><span class="line">    &#125; while (!exitPending());</span><br><span class="line">    glDeleteTextures(1, &amp;mAndroid[0].name);</span><br><span class="line">    glDeleteTextures(1, &amp;mAndroid[1].name);</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 主要工作，初始化显示的logo纹理，不断刷新界面直到exitPending()返回true，exitPenging()是Thread类中定义的函数，在checkExit()函数中通过requestExit()来执行退出</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void BootAnimation::checkExit() &#123;</span><br><span class="line">    // Allow surface flinger to gracefully request shutdown</span><br><span class="line">    char value[PROPERTY_VALUE_MAX];</span><br><span class="line">    //EXIT_PROP_NAME &quot;service.bootanim.exit&quot; 这个配置项在SurfaceFlinger的bootFinished函数中设置为1，然后这里才能退出开机动画，这个过程设计到开机启动到launcher的整个过程，这里不赘述</span><br><span class="line">    property_get(EXIT_PROP_NAME, value, &quot;0&quot;);</span><br><span class="line">    int exitnow = atoi(value);</span><br><span class="line">    if (exitnow) &#123;</span><br><span class="line">        requestExit();</span><br><span class="line">        if (mAudioPlayer != NULL) &#123;</span><br><span class="line">            mAudioPlayer-&gt;requestExit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ——————————————&gt;movie()<br> movie()这个函数有点长，我们截断一点一点的看</p>
<p>读取bootanimation.zip中的配置文件  </p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if (!readFile(&quot;desc.txt&quot;, desString)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">char const* s = desString.string();</span><br><span class="line">//读取desc.txt文件</span><br><span class="line">// Create and initialize an AudioPlayer if we have an audio_conf.txt file</span><br><span class="line">String8 audioConf;</span><br><span class="line">//判断是否需要创建AudioPlayer,这部分我们暂时不关注</span><br><span class="line">if (readFile(&quot;audio_conf.txt&quot;, audioConf)) &#123;</span><br><span class="line">    mAudioPlayer = new AudioPlayer;</span><br><span class="line">    if (!mAudioPlayer-&gt;init(audioConf.string())) &#123;</span><br><span class="line">        ALOGE(&quot;mAudioPlayer.init failed&quot;);</span><br><span class="line">        mAudioPlayer = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>解析desc.txt文件，就是上面拿到的那个char const *s  </p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">for (;;) &#123;</span><br><span class="line">        //一行一行的截取</span><br><span class="line">        const char* endl = strstr(s, &quot;\n&quot;);</span><br><span class="line">        if (!endl) break;</span><br><span class="line">        String8 line(s, endl - s);</span><br><span class="line">        const char* l = line.string();</span><br><span class="line">        //几个需要捕获的参数,帧率 宽高，次数</span><br><span class="line">        int fps, width, height, count, pause;</span><br><span class="line">        char path[ANIM_ENTRY_NAME_MAX];</span><br><span class="line">        char color[7] = &quot;000000&quot;; // default to black if unspecified</span><br><span class="line"></span><br><span class="line">        char pathType;</span><br><span class="line">        //读取帧率和宽高</span><br><span class="line">        if (sscanf(l, &quot;%d %d %d&quot;, &amp;width, &amp;height, &amp;fps) == 3) &#123;</span><br><span class="line">            // ALOGD(&quot;&gt; w=%d, h=%d, fps=%d&quot;, width, height, fps);</span><br><span class="line">            animation.width = width;</span><br><span class="line">            animation.height = height;</span><br><span class="line">            animation.fps = fps;</span><br><span class="line">        &#125;</span><br><span class="line">        //或者读取part内容</span><br><span class="line">        else if (sscanf(l, &quot; %c %d %d %s #%6s&quot;, &amp;pathType, &amp;count, &amp;pause, path, color) &gt;= 4) &#123;</span><br><span class="line">            // ALOGD(&quot;&gt; type=%c, count=%d, pause=%d, path=%s, color=%s&quot;, pathType, count, pause, path, color);</span><br><span class="line">            Animation::Part part;</span><br><span class="line">            part.playUntilComplete = pathType == &apos;c&apos;;</span><br><span class="line">            part.count = count;</span><br><span class="line">            part.pause = pause;</span><br><span class="line">            part.path = path;</span><br><span class="line">            part.audioFile = NULL;</span><br><span class="line">            if (!parseColor(color, part.backgroundColor)) &#123;</span><br><span class="line">                ALOGE(&quot;&gt; invalid color &apos;#%s&apos;&quot;, color);</span><br><span class="line">                part.backgroundColor[0] = 0.0f;</span><br><span class="line">                part.backgroundColor[1] = 0.0f;</span><br><span class="line">                part.backgroundColor[2] = 0.0f;</span><br><span class="line">            &#125;</span><br><span class="line">            animation.parts.add(part);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s = ++endl;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>读取所有的数据  </p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// read all the data structures</span><br><span class="line">const size_t pcount = animation.parts.size();</span><br><span class="line">void *cookie = NULL;</span><br><span class="line">if (!mZip-&gt;startIteration(&amp;cookie)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZipEntryRO entry;</span><br><span class="line">char name[ANIM_ENTRY_NAME_MAX];</span><br><span class="line">while ((entry = mZip-&gt;nextEntry(cookie)) != NULL) &#123;</span><br><span class="line">    const int foundEntryName = mZip-&gt;getEntryFileName(entry, name, ANIM_ENTRY_NAME_MAX);</span><br><span class="line">    if (foundEntryName &gt; ANIM_ENTRY_NAME_MAX || foundEntryName == -1) &#123;</span><br><span class="line">        ALOGE(&quot;Error fetching entry file name&quot;);</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const String8 entryName(name);</span><br><span class="line">    const String8 path(entryName.getPathDir());</span><br><span class="line">    const String8 leaf(entryName.getPathLeaf());</span><br><span class="line">    if (leaf.size() &gt; 0) &#123;</span><br><span class="line">        for (size_t j=0 ; j&lt;pcount ; j++) &#123;</span><br><span class="line">            if (path == animation.parts[j].path) &#123;</span><br><span class="line">                int method;</span><br><span class="line">                // supports only stored png files</span><br><span class="line">                if (mZip-&gt;getEntryInfo(entry, &amp;method, NULL, NULL, NULL, NULL, NULL)) &#123;</span><br><span class="line">                    if (method == ZipFileRO::kCompressStored) &#123;</span><br><span class="line">                        FileMap* map = mZip-&gt;createEntryFileMap(entry);</span><br><span class="line">                        if (map) &#123;</span><br><span class="line">                            Animation::Part&amp; part(animation.parts.editItemAt(j));</span><br><span class="line">                            if (leaf == &quot;audio.wav&quot;) &#123;</span><br><span class="line">                                // a part may have at most one audio file</span><br><span class="line">                                part.audioFile = map;</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                Animation::Frame frame;</span><br><span class="line">                                frame.name = leaf;</span><br><span class="line">                                frame.map = map;</span><br><span class="line">                                part.frames.add(frame);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mZip-&gt;endIteration(cookie);</span><br></pre></td></tr></table></figure>


<p>显示动画  </p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">// clear screen</span><br><span class="line">glShadeModel(GL_FLAT);</span><br><span class="line">glDisable(GL_DITHER);</span><br><span class="line">glDisable(GL_SCISSOR_TEST);</span><br><span class="line">glDisable(GL_BLEND);</span><br><span class="line">glClearColor(0,0,0,1);</span><br><span class="line">glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line"></span><br><span class="line">glBindTexture(GL_TEXTURE_2D, 0);</span><br><span class="line">glEnable(GL_TEXTURE_2D);</span><br><span class="line">glTexEnvx(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE);</span><br><span class="line">glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);</span><br><span class="line">glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);</span><br><span class="line">glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line">glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"></span><br><span class="line">const int xc = (mWidth - animation.width) / 2;</span><br><span class="line">const int yc = ((mHeight - animation.height) / 2);</span><br><span class="line">nsecs_t lastFrame = systemTime();</span><br><span class="line">nsecs_t frameDuration = s2ns(1) / animation.fps;</span><br><span class="line"></span><br><span class="line">Region clearReg(Rect(mWidth, mHeight));</span><br><span class="line">clearReg.subtractSelf(Rect(xc, yc, xc+animation.width, yc+animation.height));</span><br><span class="line"></span><br><span class="line">for (size_t i=0 ; i&lt;pcount ; i++) &#123;</span><br><span class="line">    const Animation::Part&amp; part(animation.parts[i]);</span><br><span class="line">    const size_t fcount = part.frames.size();</span><br><span class="line">    glBindTexture(GL_TEXTURE_2D, 0);</span><br><span class="line"></span><br><span class="line">    for (int r=0 ; !part.count || r&lt;part.count ; r++) &#123;</span><br><span class="line">        // Exit any non playuntil complete parts immediately</span><br><span class="line">        if(exitPending() &amp;&amp; !part.playUntilComplete)</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        // only play audio file the first time we animate the part</span><br><span class="line">        if (r == 0 &amp;&amp; mAudioPlayer != NULL &amp;&amp; part.audioFile) &#123;</span><br><span class="line">            mAudioPlayer-&gt;playFile(part.audioFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        glClearColor(</span><br><span class="line">                part.backgroundColor[0],</span><br><span class="line">                part.backgroundColor[1],</span><br><span class="line">                part.backgroundColor[2],</span><br><span class="line">                1.0f);</span><br><span class="line"></span><br><span class="line">        for (size_t j=0 ; j&lt;fcount &amp;&amp; (!exitPending() || part.playUntilComplete) ; j++) &#123;</span><br><span class="line">            const Animation::Frame&amp; frame(part.frames[j]);</span><br><span class="line">            nsecs_t lastFrame = systemTime();</span><br><span class="line"></span><br><span class="line">            if (r &gt; 0) &#123;</span><br><span class="line">                glBindTexture(GL_TEXTURE_2D, frame.tid);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (part.count != 1) &#123;</span><br><span class="line">                    glGenTextures(1, &amp;frame.tid);</span><br><span class="line">                    glBindTexture(GL_TEXTURE_2D, frame.tid);</span><br><span class="line">                    glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line">                    glTexParameterx(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line">                &#125;</span><br><span class="line">                initTexture(frame);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!clearReg.isEmpty()) &#123;</span><br><span class="line">                Region::const_iterator head(clearReg.begin());</span><br><span class="line">                Region::const_iterator tail(clearReg.end());</span><br><span class="line">                glEnable(GL_SCISSOR_TEST);</span><br><span class="line">                while (head != tail) &#123;</span><br><span class="line">                    const Rect&amp; r(*head++);</span><br><span class="line">                    glScissor(r.left, mHeight - r.bottom,</span><br><span class="line">                            r.width(), r.height());</span><br><span class="line">                    glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">                &#125;</span><br><span class="line">                glDisable(GL_SCISSOR_TEST);</span><br><span class="line">            &#125;</span><br><span class="line">            glDrawTexiOES(xc, yc, 0, animation.width, animation.height);</span><br><span class="line">            eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line"></span><br><span class="line">            nsecs_t now = systemTime();</span><br><span class="line">            nsecs_t delay = frameDuration - (now - lastFrame);</span><br><span class="line">            //ALOGD(&quot;%lld, %lld&quot;, ns2ms(now - lastFrame), ns2ms(delay));</span><br><span class="line">            lastFrame = now;</span><br><span class="line"></span><br><span class="line">            if (delay &gt; 0) &#123;</span><br><span class="line">                struct timespec spec;</span><br><span class="line">                spec.tv_sec  = (now + delay) / 1000000000;</span><br><span class="line">                spec.tv_nsec = (now + delay) % 1000000000;</span><br><span class="line">                int err;</span><br><span class="line">                do &#123;</span><br><span class="line">                    err = clock_nanosleep(CLOCK_MONOTONIC, TIMER_ABSTIME, &amp;spec, NULL);</span><br><span class="line">                &#125; while (err&lt;0 &amp;&amp; errno == EINTR);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkExit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        usleep(part.pause * ns2us(frameDuration));</span><br><span class="line"></span><br><span class="line">        // For infinite parts, we&apos;ve now played them at least once, so perhaps exit</span><br><span class="line">        if(exitPending() &amp;&amp; !part.count)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // free the textures for this part</span><br><span class="line">    if (part.count != 1) &#123;</span><br><span class="line">        for (size_t j=0 ; j&lt;fcount ; j++) &#123;</span><br><span class="line">            const Animation::Frame&amp; frame(part.frames[j]);</span><br><span class="line">            glDeleteTextures(1, &amp;frame.tid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><p> 主要工作，贴代码，加自己的理解，有问题留言。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-08-07T10:46:44.000Z">2016-08-07</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 分钟 读完 (大约 956 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2016/08/07/《Android Framework 之路》BootAnimation（1）/">《Android Framework 之路》BootAnimation（1）</a>
            
        </h1>
        <div class="content">
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p>开机动画，BootAnimation，就是Android手机开机郭晨各种以一个展示给用户的界面，实际是一个多个帧组成的动画，在界面上进行一帧一帧的播放，形成开机动画的效果。<br>本文针对Android5.1源码分析BootAnimation</p>
</blockquote>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                <a class="button is-size-7 is-light" href="/2016/08/07/《Android Framework 之路》BootAnimation（1）/#more">阅读更多</a>
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-04-26T15:02:25.000Z">2016-04-26</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    3 分钟 读完 (大约 384 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2016/04/26/《Android Framework 之路》多线程/">《Android Framework 之路》多线程</a>
            
        </h1>
        <div class="content">
            <p>  ####多线程编程####<br> JAVA多线程方式</p>
<ol start="2">
<li><p>继承Thread线程，实现run方法 </p>
</li>
<li><p>实现Runnable接口  JAVA单继承性，当我们想将一个已经继承了其他类的子类放到Thread中时，单继承的局限就体现出来了<br>但是可以实现多个接口，所以第二种方法相对于第一种来说灵活许多<br>其次，通过<br>new Thread(Runnable runnable).start()<br>启动线程的方式，若变量在runnable中定义，多个线程可以共用，因为来自同一个对象<br>比较适合多个相同程序代码的线程去处理同一资源的情况</p>
<p>Android多线程方式<br>主要集中在UI线程和其他线程的交互问题上</p>
</li>
</ol>
<ol start="2">
<li>Thread,Handler,Message </li>
<li>AsyncTask </li>
<li>Runnable  第一种方式，new Thread()然后通过Handler sendMessage,由Handler的handleMessage方法实现对应的处理，完成与UI进程的交互</li>
</ol>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private Handler mHandler =  new Handler()&#123;</span><br><span class="line">    public void handleMessage(Message msg) &#123;</span><br><span class="line">        /*do sth through msg */</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public BadThread extends Thread &#123;</span><br><span class="line">    private final static String TAG = this.getClass().getName();</span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line">       /*coding*/</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">new BadThread().start();</span><br></pre></td></tr></table></figure>

<p> 第二种方式，异步线程的方式，doInBackground()中执行任务，onPreExecute()准备工作，onPostExecute()任务结束后调用，onProgressUpdate与publishProgress配合使用，实现和UI线程的交互</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AsyncTask mLoadingTask = new AsyncTask()&#123;</span><br><span class="line">    protected Object doInBackground(Object[] objects) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    protected void onProgressUpdate(Object[] values) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mLoadingTask.execute();</span><br></pre></td></tr></table></figure>

<p> 第三种方式，Runnable对象，通过Handler直接Post等方法启动线程，实现与UI线程的交互</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private Runnable mRunnable = new Runnable()&#123;</span><br><span class="line">    public void run() &#123; </span><br><span class="line">        /*do sth*/</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mHandler.post(mRunnable);</span><br></pre></td></tr></table></figure>



        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-04-20T15:01:31.000Z">2016-04-20</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 分钟 读完 (大约 608 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2016/04/20/《Android HAL 之路》 HAL 简介/">《Android HAL 之路》 HAL 简介</a>
            
        </h1>
        <div class="content">
            <p>  ###HAL层概述<br> 名称： HAL， Hardware Abstracting Layer，中文名字：硬件抽象层。<br> 作用：对Linux内核驱动程序的封装，向上提供接口，屏蔽低层的实现细节。向上衔接Android Runtime和Framework，向下衔接驱动程序<br> 产生原因：利益，竞争</p>
<p> Android代码结构中，HAL层的内容主要集中在Hardware目录中，结合之前讲解Camera模块的时候提到的<br> system/lib/hw/camera.$(TARGET_BOARD_PLATFORM).so</p>
<p> HAL层的内容集成在动态库中，然后CameraService通过这个So访问其中的内容。</p>
<p> ###如何访问？<br> void CameraService::onFirstRef()<br> hw_get_module(CAMERA_HARDWARE_MODULE_ID, (const hw_module_t **)&amp;rawModule)<br> 每一个独立的HAL层的so，有一个与其对应的Id  </p>
<p> #define CAMERA_HARDWARE_MODULE_ID “camera”<br> 定义在hardware/libhardware/include/hardware/camera_common.h<br> 又或者<br> system/lib/hw/audio.primary.$(TARGET_BOARD_PLATFORM)<br> frameworks/av/services/audioflinger/AudioFlinger.cpp<br> rc = hw_get_module_by_class(AUDIO_HARDWARE_MODULE_ID, if_name, &amp;mod);  </p>
<p> #define AUDIO_HARDWARE_MODULE_ID “audio”<br> 定义在<br> hardware/libhardware/include/hardware/audio.h<br> 当然这里只是举个例子，Audio需要加载的模块不止这一个。</p>
<p> 基本上每一个模块对应一个So，命名方式也是比较相似，xxx.$(TARGET_BOARD_PLATFORM),存放路径<br> system/lib/hw<br> system/lib64/hw</p>
<p> <em><strong>hw_get_module -&gt;hw_get_module_by_class</strong></em><br> 定义在hardware/libhardware/include/hardware/hardware.h<br> 实现在hardware/libhardware/hardware.c</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">int hw_get_module(const char *id, const struct hw_module_t **module)</span><br><span class="line">&#123;</span><br><span class="line">    return hw_get_module_by_class(id, NULL, module);</span><br><span class="line">&#125;</span><br><span class="line">……</span><br><span class="line">int hw_get_module_by_class(const char *class_id, const char *inst,</span><br><span class="line">                           const struct hw_module_t **module)</span><br><span class="line">&#123;</span><br><span class="line">    int i = 0;</span><br><span class="line">    char prop[PATH_MAX] = &#123;0&#125;;</span><br><span class="line">    char path[PATH_MAX] = &#123;0&#125;;</span><br><span class="line">    char name[PATH_MAX] = &#123;0&#125;;</span><br><span class="line">    char prop_name[PATH_MAX] = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if (inst)//如果inst不为空，name= class_id.inst</span><br><span class="line">        snprintf(name, PATH_MAX, &quot;%s.%s&quot;, class_id, inst);</span><br><span class="line">    else //如果为空的话，name = class_id</span><br><span class="line">        strlcpy(name, class_id, PATH_MAX);</span><br><span class="line">    </span><br><span class="line">    //判断是否有配置项定义了对应的Hal层</span><br><span class="line">    snprintf(prop_name, sizeof(prop_name), &quot;ro.hardware.%s&quot;, name);</span><br><span class="line">    if (property_get(prop_name, prop, NULL) &gt; 0) &#123;</span><br><span class="line">        if (hw_module_exists(path, sizeof(path), name, prop) == 0) &#123;//若存在则跳转</span><br><span class="line">            goto found;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //循环查找ro.hardware，ro.product.board，ro.board.platform，ro.arch</span><br><span class="line">    for (i=0 ; i&lt;HAL_VARIANT_KEYS_COUNT; i++) &#123;</span><br><span class="line">        if (property_get(variant_keys[i], prop, NULL) == 0) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (hw_module_exists(path, sizeof(path), name, prop) == 0) &#123;</span><br><span class="line">            goto found;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Nothing found, try the default */</span><br><span class="line">    if (hw_module_exists(path, sizeof(path), name, &quot;default&quot;) == 0) &#123;</span><br><span class="line">        goto found;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return -ENOENT;</span><br><span class="line"></span><br><span class="line">found:</span><br><span class="line">    /* load the module, if this fails, we&apos;re doomed, and we should not try</span><br><span class="line">     * to load a different variant. */</span><br><span class="line">    return load(class_id, path, module);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 再看看hw_module_exists这个方法</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static int hw_module_exists(char *path, size_t path_len, const char *name,</span><br><span class="line">                            const char *subname)</span><br><span class="line">&#123;</span><br><span class="line">   //拼凑HAL so库的名字 /vendor/lib/hw/name.subname.so或者/vendor/lib64/hw/name.subname.so</span><br><span class="line">    snprintf(path, path_len, &quot;%s/%s.%s.so&quot;,</span><br><span class="line">             HAL_LIBRARY_PATH2, name, subname);</span><br><span class="line">    if (access(path, R_OK) == 0)</span><br><span class="line">        return 0;</span><br><span class="line">   //拼凑HAL so库的名字 /system/lib/hw/name.subname.so或者/system/lib64/hw/name.subname.so</span><br><span class="line">    snprintf(path, path_len, &quot;%s/%s.%s.so&quot;,</span><br><span class="line">             HAL_LIBRARY_PATH1, name, subname);</span><br><span class="line">    if (access(path, R_OK) == 0)</span><br><span class="line">        return 0;</span><br><span class="line"></span><br><span class="line">    return -ENOENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 以audio其中的一个so为例，在源码中找一个芯片平台高通msm8974<br> system/lib/hw/audio.primary.msm8974.so<br> 顺着以上的代码很好理解，当然这个msm8974必然是可以用过循环的那几个配置项其中的一个获取，否则就是<br> system/lib/hw/audio.promary.default.so</p>
<p> ###如何加载<br> 以上代码跳转到found之后<br> return load(class_id, path, module);</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static int load(const char *id,</span><br><span class="line">        const char *path,</span><br><span class="line">        const struct hw_module_t **pHmi)</span><br><span class="line">&#123;</span><br><span class="line">    ……  //打开so,获取句柄  </span><br><span class="line">    handle = dlopen(path, RTLD_NOW);</span><br><span class="line">    ……</span><br><span class="line"></span><br><span class="line">    /* Get the address of the struct hal_module_info. */</span><br><span class="line">    //获取地址空间的入口</span><br><span class="line">    const char *sym = HAL_MODULE_INFO_SYM_AS_STR;</span><br><span class="line">    hmi = (struct hw_module_t *)dlsym(handle, sym);</span><br><span class="line">    ……</span><br><span class="line">    ……</span><br><span class="line">    </span><br><span class="line">    hmi-&gt;dso = handle;</span><br><span class="line">    ……</span><br><span class="line">    *pHmi = hmi; //赋值给传入参数</span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 最后上层拿到的就是hw_module_t *  
 然后通过这个入口操作库中的内容，并且每一个HAL模块在定义自己的结构的时候也是需要按照一定的规范来执行。这个留着明天再写吧……</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2015-09-13T11:41:46.000Z">2015-09-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 分钟 读完 (大约 334 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2015/09/13/《Android Framework 之路》Android5.1 Camera Framework（四）——框架总结/">《Android Framework 之路》Android5.1 Camera Framework（四）——框架总结</a>
            
        </h1>
        <div class="content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p> 从之前的几篇文件，可以基本弄清楚 Camera从APK，经过framework的衔接，与HAL层进行交互，最终通过驱动完成Camera的一些动作。</p>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                <a class="button is-size-7 is-light" href="/2015/09/13/《Android Framework 之路》Android5.1 Camera Framework（四）——框架总结/#more">阅读更多</a>
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2015-08-30T14:46:49.000Z">2015-08-30</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    16 分钟 读完 (大约 2392 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2015/08/30/《Android Framework 之路》Android5.1 Camera Framework（三）/">《Android Framework 之路》Android5.1 Camera Framework（三）</a>
            
        </h1>
        <div class="content">
            <blockquote>
<p>上一次讲解了一下startPreview过程，主要是为了画出一条大致的从上到下的线条，今天我们看一下Camera在Framework的sendCommand和dataCallback，这部分属于衔接过程，可以看到上下是如何交流沟通的。</p>
</blockquote>
<h2 id="首先，sendCommand"><a href="#首先，sendCommand" class="headerlink" title="首先，sendCommand"></a>首先，sendCommand</h2><p> Camera.java中并没有sendCommand方法，在Camera.cpp中存在sendCommand函数，所以这个sendCommand是从android_hardware_interface.cpp中开始使用的</p>
<p> android_hardware_Camera.cpp (base\core\jni)</p>
<p> startSmoothZoom<br> android_hardware_Camera_startSmoothZoom<br> ——&gt;CAMERA_CMD_START_SMOOTH_ZOOM</p>
<p> stopSmoothZoom<br> android_hardware_Camera_stopSmoothZoom<br> ——&gt;CAMERA_CMD_STOP_SMOOTH_ZOOM</p>
<p> setDisplayOrientation<br> android_hardware_Camera_setDisplayOrientation<br> ——&gt;CAMERA_CMD_SET_DISPLAY_ORIENTATION</p>
<p> _enableShutterSound<br> android_hardware_Camera_enableShutterSound<br> ——&gt;CAMERA_CMD_ENABLE_SHUTTER_SOUND</p>
<p> _startFaceDetection<br> android_hardware_Camera_startFaceDetection<br> ——&gt;CAMERA_CMD_START_FACE_DETECTION</p>
<p> _stopFaceDetection<br> android_hardware_Camera_stopFaceDetection<br> ——&gt;CAMERA_CMD_STOP_FACE_DETECTION</p>
<p> enableFocusMoveCallback<br> android_hardware_Camera_enableFocusMoveCallback<br> ——&gt;CAMERA_CMD_ENABLE_FOCUS_MOVE_MSG</p>
<p> 诸如此类的命令类型定义在Camera.h (system\core\include\system)<br> enum {<br> CAMERA_CMD_START_SMOOTH_ZOOM = 1,<br> CAMERA_CMD_STOP_SMOOTH_ZOOM = 2,<br> CAMERA_CMD_SET_DISPLAY_ORIENTATION = 3,<br> CAMERA_CMD_ENABLE_SHUTTER_SOUND = 4,<br> CAMERA_CMD_PLAY_RECORDING_SOUND = 5,<br> CAMERA_CMD_START_FACE_DETECTION = 6,<br> CAMERA_CMD_STOP_FACE_DETECTION = 7,<br> CAMERA_CMD_ENABLE_FOCUS_MOVE_MSG = 8,<br> CAMERA_CMD_PING = 9,<br> CAMERA_CMD_SET_VIDEO_BUFFER_COUNT = 10,<br> };</p>
<p> 以上者几种操作都是采用sendCommand()的函数来实现的，对应的命令类型也列举出来了，HAL层会根据这个消息类型做出判断，然后做出对应的操作。<br> 来看下sendCommand的实现：<br> Camera.cpp (frameworks\av\camera)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// send command to camera driver</span></span><br><span class="line"><span class="hljs-keyword">status_t</span> Camera::sendCommand(<span class="hljs-keyword">int32_t</span> cmd, <span class="hljs-keyword">int32_t</span> arg1, <span class="hljs-keyword">int32_t</span> arg2)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"sendCommand"</span>);</span><br><span class="line">    sp &lt;ICamera&gt; c = mCamera;</span><br><span class="line">    <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> NO_INIT;</span><br><span class="line">    <span class="hljs-keyword">return</span> c-&gt;sendCommand(cmd, arg1, arg2);  <span class="hljs-comment">//三个参数，第一个是消息类型，后面两个参数有时候使用有时不使用，这里应该是具有扩展性的，如果需要添加更多的参数，上下接口同时修改就可以了。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过Binder机制，</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">virtual</span> status_t <span class="hljs-title">sendCommand</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> cmd, <span class="hljs-keyword">int32_t</span> arg1, <span class="hljs-keyword">int32_t</span> arg2)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"sendCommand"</span>);</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    data.writeInterfaceToken(ICamera::getInterfaceDescriptor());</span><br><span class="line">    data.writeInt32(cmd);</span><br><span class="line">    data.writeInt32(arg1);</span><br><span class="line">    data.writeInt32(arg2);</span><br><span class="line">    remote()-&gt;transact(SEND_COMMAND, data, &amp;reply);</span><br><span class="line">    <span class="hljs-keyword">return</span> reply.readInt32();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> BnCamera::onTransact(</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> code, <span class="hljs-keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="hljs-keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="hljs-keyword">case</span> SEND_COMMAND: &#123;</span><br><span class="line">            ALOGV(<span class="hljs-string">"SEND_COMMAND"</span>);</span><br><span class="line">            CHECK_INTERFACE(ICamera, data, reply);</span><br><span class="line">            <span class="hljs-keyword">int</span> command = data.readInt32();</span><br><span class="line">            <span class="hljs-keyword">int</span> arg1 = data.readInt32();</span><br><span class="line">            <span class="hljs-keyword">int</span> arg2 = data.readInt32();</span><br><span class="line">            reply-&gt;writeInt32(sendCommand(command, arg1, arg2));</span><br><span class="line">            <span class="hljs-keyword">return</span> NO_ERROR;</span><br><span class="line">         &#125; <span class="hljs-keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用到</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> CameraClient::sendCommand(<span class="hljs-keyword">int32_t</span> cmd, <span class="hljs-keyword">int32_t</span> arg1, <span class="hljs-keyword">int32_t</span> arg2) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="hljs-keyword">if</span> (cmd == CAMERA_CMD_SET_DISPLAY_ORIENTATION) &#123;</span><br><span class="line">        <span class="hljs-comment">// Mirror the preview if the camera is front-facing.</span></span><br><span class="line">        orientation = getOrientation(arg1, mCameraFacing == CAMERA_FACING_FRONT);</span><br><span class="line">        <span class="hljs-keyword">if</span> (orientation == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> BAD_VALUE;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (mOrientation != orientation) &#123;</span><br><span class="line">            mOrientation = orientation;</span><br><span class="line">            <span class="hljs-keyword">if</span> (mPreviewWindow != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                native_window_set_buffers_transform(mPreviewWindow.get(),</span><br><span class="line">                        mOrientation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> OK;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == CAMERA_CMD_ENABLE_SHUTTER_SOUND) &#123;</span><br><span class="line">        <span class="hljs-keyword">switch</span> (arg1) &#123;    <span class="hljs-comment">//这里就是对参数arg1的使用，通过参数来开关拍照声音</span></span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: </span><br><span class="line">                <span class="hljs-keyword">return</span> enableShutterSound(<span class="hljs-literal">false</span>);</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:</span><br><span class="line">                <span class="hljs-keyword">return</span> enableShutterSound(<span class="hljs-literal">true</span>);</span><br><span class="line">            <span class="hljs-keyword">default</span>:</span><br><span class="line">                <span class="hljs-keyword">return</span> BAD_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> OK;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == CAMERA_CMD_PLAY_RECORDING_SOUND) &#123; <span class="hljs-comment">//录像声音</span></span><br><span class="line">        mCameraService-&gt;playSound(CameraService::SOUND_RECORDING);</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == CAMERA_CMD_SET_VIDEO_BUFFER_COUNT) &#123;</span><br><span class="line">        <span class="hljs-comment">// Silently ignore this command</span></span><br><span class="line">        <span class="hljs-keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == CAMERA_CMD_PING) &#123;</span><br><span class="line">        <span class="hljs-comment">// If mHardware is 0, checkPidAndHardware will return error.</span></span><br><span class="line">        <span class="hljs-keyword">return</span> OK;</span><br><span class="line">    &#125; <span class="hljs-comment">//以上是framework可以处理的命令</span></span><br><span class="line">    <span class="hljs-keyword">return</span> mHardware-&gt;sendCommand(cmd, arg1, arg2);  <span class="hljs-comment">//HAL层处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在HAL层中处理的消息类型主要是打开和停止人脸检测过程，<br>QCamera2HWI.cpp (\device\asus\flo\camera\qcamera2\hal)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> QCamera2HardwareInterface::sendCommand(<span class="hljs-keyword">int32_t</span> command, <span class="hljs-keyword">int32_t</span> <span class="hljs-comment">/*arg1*/</span>, <span class="hljs-keyword">int32_t</span> <span class="hljs-comment">/*arg2*/</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> rc = NO_ERROR;</span><br><span class="line">    <span class="hljs-keyword">switch</span> (command) &#123;</span><br><span class="line">    <span class="hljs-keyword">case</span> CAMERA_CMD_START_FACE_DETECTION:</span><br><span class="line">    <span class="hljs-keyword">case</span> CAMERA_CMD_STOP_FACE_DETECTION:</span><br><span class="line">        <span class="hljs-comment">//开关人脸检测</span></span><br><span class="line">        rc = setFaceDetection(command == CAMERA_CMD_START_FACE_DETECTION? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">default</span>:</span><br><span class="line">        rc = NO_ERROR;</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上，如上就是sendCommand的过程</p>
<h2 id="然后，回调Callback"><a href="#然后，回调Callback" class="headerlink" title="然后，回调Callback"></a>然后，回调Callback</h2><p> 从之前的文章可以看到callback主要有三种类型<br> notifyCallback<br> dataCallback<br> dataTimestampCallback</p>
<p> 这个过程我们就不能按照之前的从上至下的跟过程了，这次需要反着来，从HAL层回调到<br> CameraHardwareInterface.h (frameworks\av\services\camera\libcameraservice\device1)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __notify_cb(<span class="hljs-keyword">int32_t</span> msg_type, <span class="hljs-keyword">int32_t</span> ext1,</span><br><span class="line">                        <span class="hljs-keyword">int32_t</span> ext2, <span class="hljs-keyword">void</span> *user)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"%s"</span>, __FUNCTION__);</span><br><span class="line">    CameraHardwareInterface *__this =</span><br><span class="line">            <span class="hljs-keyword">static_cast</span>&lt;CameraHardwareInterface *&gt;(user);</span><br><span class="line">    __this-&gt;mNotifyCb(msg_type, ext1, ext2, __this-&gt;mCbUser);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __data_cb(<span class="hljs-keyword">int32_t</span> msg_type,</span><br><span class="line">                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">camera_memory_t</span> *data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> index,</span><br><span class="line">                      <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata,</span><br><span class="line">                      <span class="hljs-keyword">void</span> *user)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"%s"</span>, __FUNCTION__);</span><br><span class="line">    CameraHardwareInterface *__this =</span><br><span class="line">            <span class="hljs-keyword">static_cast</span>&lt;CameraHardwareInterface *&gt;(user);</span><br><span class="line">    ......</span><br><span class="line">    __this-&gt;mDataCb(msg_type, mem-&gt;mBuffers[index], metadata, __this-&gt;mCbUser);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __data_cb_timestamp(<span class="hljs-keyword">nsecs_t</span> timestamp, <span class="hljs-keyword">int32_t</span> msg_type,</span><br><span class="line">                         <span class="hljs-keyword">const</span> <span class="hljs-keyword">camera_memory_t</span> *data, <span class="hljs-keyword">unsigned</span> index,</span><br><span class="line">                         <span class="hljs-keyword">void</span> *user)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"%s"</span>, __FUNCTION__);</span><br><span class="line">    CameraHardwareInterface *__this =</span><br><span class="line">            <span class="hljs-keyword">static_cast</span>&lt;CameraHardwareInterface *&gt;(user);</span><br><span class="line">    ......</span><br><span class="line">    __this-&gt;mDataCbTimestamp(timestamp, msg_type, mem-&gt;mBuffers[index], __this-&gt;mCbUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 其中的mNotifyCb，mDataCb，mDataCbTimestamp是在CameraClient::initialize函数中设置的</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setCallbacks</span><span class="hljs-params">(notify_callback notify_cb,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                  data_callback data_cb,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                  data_callback_timestamp data_cb_timestamp,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                  <span class="hljs-keyword">void</span>* user)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    mNotifyCb = notify_cb;</span><br><span class="line">    mDataCb = data_cb;</span><br><span class="line">    mDataCbTimestamp = data_cb_timestamp;</span><br><span class="line">    mCbUser = user;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="hljs-string">"%s(%s)"</span>, __FUNCTION__, mName.<span class="hljs-built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (mDevice-&gt;ops-&gt;set_callbacks) &#123;</span><br><span class="line">        mDevice-&gt;ops-&gt;set_callbacks(mDevice,</span><br><span class="line">                               __notify_cb,</span><br><span class="line">                               __data_cb,</span><br><span class="line">                               __data_cb_timestamp,</span><br><span class="line">                               __get_memory,</span><br><span class="line">                               <span class="hljs-keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 回调自然是到CameraClient中去找了</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">void</span> CameraClient::notifyCallback(<span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">int32_t</span> ext1,</span><br><span class="line">        <span class="hljs-keyword">int32_t</span> ext2, <span class="hljs-keyword">void</span>* user) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">void</span> CameraClient::dataCallback(<span class="hljs-keyword">int32_t</span> msgType,</span><br><span class="line">        <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr, <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata, <span class="hljs-keyword">void</span>* user) &#123;</span><br><span class="line">    LOG2(<span class="hljs-string">"dataCallback(%d)"</span>, msgType);</span><br><span class="line"></span><br><span class="line">    Mutex* lock = getClientLockFromCookie(user);</span><br><span class="line">    <span class="hljs-keyword">if</span> (lock == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;</span><br><span class="line">    Mutex::<span class="hljs-function">Autolock <span class="hljs-title">alock</span><span class="hljs-params">(*lock)</span></span>;</span><br><span class="line"></span><br><span class="line">    CameraClient* client =</span><br><span class="line">            <span class="hljs-keyword">static_cast</span>&lt;CameraClient*&gt;(getClientFromCookie(user));</span><br><span class="line">    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (!client-&gt;lockIfMessageWanted(msgType)) <span class="hljs-keyword">return</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (dataPtr == <span class="hljs-number">0</span> &amp;&amp; metadata == <span class="hljs-literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"Null data returned in data callback"</span>);</span><br><span class="line">        client-&gt;handleGenericNotify(CAMERA_MSG_ERROR, UNKNOWN_ERROR, <span class="hljs-number">0</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">switch</span> (msgType &amp; ~CAMERA_MSG_PREVIEW_METADATA) &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_PREVIEW_FRAME:</span><br><span class="line">            client-&gt;handlePreviewData(msgType, dataPtr, metadata);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_POSTVIEW_FRAME:</span><br><span class="line">            client-&gt;handlePostview(dataPtr);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_RAW_IMAGE:</span><br><span class="line">            client-&gt;handleRawPicture(dataPtr);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_COMPRESSED_IMAGE:</span><br><span class="line">            client-&gt;handleCompressedPicture(dataPtr);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        <span class="hljs-keyword">default</span>:</span><br><span class="line">            client-&gt;handleGenericData(msgType, dataPtr, metadata);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">void</span> CameraClient::dataCallbackTimestamp(<span class="hljs-keyword">nsecs_t</span> timestamp,</span><br><span class="line">        <span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr, <span class="hljs-keyword">void</span>* user) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要看下dataCallback的过程吧，</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">switch</span> (msgType &amp; ~CAMERA_MSG_PREVIEW_METADATA) &#123;</span><br><span class="line">    <span class="hljs-keyword">case</span> CAMERA_MSG_PREVIEW_FRAME:  <span class="hljs-comment">//预览帧数据</span></span><br><span class="line">        client-&gt;handlePreviewData(msgType, dataPtr, metadata);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">case</span> CAMERA_MSG_POSTVIEW_FRAME: <span class="hljs-comment">//postview image</span></span><br><span class="line">        client-&gt;handlePostview(dataPtr);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">case</span> CAMERA_MSG_RAW_IMAGE:   <span class="hljs-comment">//原始数据</span></span><br><span class="line">        client-&gt;handleRawPicture(dataPtr);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">case</span> CAMERA_MSG_COMPRESSED_IMAGE: <span class="hljs-comment">//真实图片</span></span><br><span class="line">        client-&gt;handleCompressedPicture(dataPtr);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">default</span>:</span><br><span class="line">        client-&gt;handleGenericData(msgType, dataPtr, metadata);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里最后会调用到<br> c-&gt;dataCallback，然后根据消息类型来做处理，然后在通过binder机制</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// generic data callback from camera service to app with image data</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dataCallback</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; imageData,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                  <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"dataCallback"</span>);</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    data.writeInterfaceToken(ICameraClient::getInterfaceDescriptor());</span><br><span class="line">    data.writeInt32(msgType);</span><br><span class="line">    data.writeStrongBinder(imageData-&gt;asBinder());</span><br><span class="line">    <span class="hljs-keyword">if</span> (metadata) &#123;</span><br><span class="line">        data.writeInt32(metadata-&gt;number_of_faces);</span><br><span class="line">        data.write(metadata-&gt;faces, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">camera_face_t</span>) * metadata-&gt;number_of_faces);</span><br><span class="line">    &#125;</span><br><span class="line">    remote()-&gt;transact(DATA_CALLBACK, data, &amp;reply, IBinder::FLAG_ONEWAY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> BnCameraClient::onTransact(</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> code, <span class="hljs-keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="hljs-keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">switch</span>(code) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="hljs-keyword">case</span> DATA_CALLBACK: &#123;</span><br><span class="line">            ALOGV(<span class="hljs-string">"DATA_CALLBACK"</span>);</span><br><span class="line">            CHECK_INTERFACE(ICameraClient, data, reply);</span><br><span class="line">            <span class="hljs-keyword">int32_t</span> msgType = data.readInt32();</span><br><span class="line">            sp&lt;IMemory&gt; imageData = interface_cast&lt;IMemory&gt;(data.readStrongBinder());</span><br><span class="line">            <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata = <span class="hljs-literal">NULL</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (data.dataAvail() &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                metadata = <span class="hljs-keyword">new</span> <span class="hljs-keyword">camera_frame_metadata_t</span>;</span><br><span class="line">                metadata-&gt;number_of_faces = data.readInt32();</span><br><span class="line">                metadata-&gt;faces = (<span class="hljs-keyword">camera_face_t</span> *) data.readInplace(</span><br><span class="line">                        <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">camera_face_t</span>) * metadata-&gt;number_of_faces);</span><br><span class="line">            &#125;</span><br><span class="line">            dataCallback(msgType, imageData, metadata);</span><br><span class="line">            <span class="hljs-keyword">if</span> (metadata) <span class="hljs-keyword">delete</span> metadata;</span><br><span class="line">            <span class="hljs-keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125; <span class="hljs-keyword">break</span>;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里转到Camera.cpp</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// callback from camera service when frame or image is ready</span></span><br><span class="line"><span class="hljs-keyword">void</span> Camera::dataCallback(<span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr,</span><br><span class="line">                          <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;CameraListener&gt; listener;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        listener = mListener;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (listener != <span class="hljs-literal">NULL</span>) &#123;</span><br><span class="line">        listener-&gt;postData(msgType, dataPtr, metadata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 通过listener的方式来往上层甩数据，那么问题来了，这个listener是什么时候设置的？<br> 回想一下第一篇FWK分析博客中的native_setup过程中有这么一段</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;JNICameraContext&gt; context = <span class="hljs-keyword">new</span> JNICameraContext(env, weak_this, clazz, camera);</span><br><span class="line">context-&gt;incStrong((<span class="hljs-keyword">void</span>*)android_hardware_Camera_native_setup);</span><br><span class="line">camera-&gt;setListener(context);</span><br></pre></td></tr></table></figure>

<p> 就是在这里设置的listener,JNICameraContext继承CameraListener，复写父类的方法</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JNICameraContext</span>:</span> <span class="hljs-keyword">public</span> CameraListener&#123;</span><br><span class="line">    ......   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CameraListener</span>:</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> RefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notify</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">int32_t</span> ext1, <span class="hljs-keyword">int32_t</span> ext2)</span> </span>= <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postData</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                          <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata)</span> </span>= <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postDataTimestamp</span><span class="hljs-params">(<span class="hljs-keyword">nsecs_t</span> timestamp, <span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr)</span> </span>= <span class="hljs-number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> 承接上面那一段，这里我们只看postData()<br> android_hardware_Camera.cpp (frameworks\base\core\jni)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">void</span> JNICameraContext::postData(<span class="hljs-keyword">int32_t</span> msgType, <span class="hljs-keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr,</span><br><span class="line">                                <span class="hljs-keyword">camera_frame_metadata_t</span> *metadata)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="hljs-keyword">int32_t</span> dataMsgType = msgType &amp; ~CAMERA_MSG_PREVIEW_METADATA;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// return data based on callback type</span></span><br><span class="line">    <span class="hljs-keyword">switch</span> (dataMsgType) &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_VIDEO_FRAME:</span><br><span class="line">            <span class="hljs-comment">// should never happen</span></span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// For backward-compatibility purpose, if there is no callback</span></span><br><span class="line">        <span class="hljs-comment">// buffer for raw image, the callback returns null.</span></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_RAW_IMAGE:</span><br><span class="line">            ALOGV(<span class="hljs-string">"rawCallback"</span>);</span><br><span class="line">            <span class="hljs-keyword">if</span> (mRawImageCallbackBuffers.isEmpty()) &#123;</span><br><span class="line">                env-&gt;CallStaticVoidMethod(mCameraJClass, fields.post_event,</span><br><span class="line">                        mCameraJObjectWeak, dataMsgType, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                copyAndPost(env, dataPtr, dataMsgType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// There is no data.</span></span><br><span class="line">        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">default</span>:</span><br><span class="line">            ALOGV(<span class="hljs-string">"dataCallback(%d, %p)"</span>, dataMsgType, dataPtr.get());</span><br><span class="line">            copyAndPost(env, dataPtr, dataMsgType);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// post frame metadata to Java</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (metadata &amp;&amp; (msgType &amp; CAMERA_MSG_PREVIEW_METADATA)) &#123;</span><br><span class="line">        postMetadata(env, CAMERA_MSG_PREVIEW_METADATA, metadata);<span class="hljs-comment">//这里有人脸数据</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里涉及到的<br> env-&gt;CallStaticVoidMethod(mCameraJClass, fields.post_event,<br> mCameraJObjectWeak, dataMsgType, 0, 0, NULL);<br> copyAndPost(env, dataPtr, dataMsgType);<br> postMetadata(env, CAMERA_MSG_PREVIEW_METADATA, metadata);<br> 直接或间接的使用到fileds.post_event函数，这里是JNI中的方法注册，<br> fields.post_event = env-&gt;GetStaticMethodID(clazz, “postEventFromNative”,<br> “(Ljava/lang/Object;IIILjava/lang/Object;)V”);<br> 这个是在register_android_hardware_Camera()函数中调用的，这里不做过多停留，这个实际会调用到<br> Camera.java (frameworks\base\core\java\android\hardware)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postEventFromNative</span><span class="hljs-params">(Object camera_ref,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                        <span class="hljs-keyword">int</span> what, <span class="hljs-keyword">int</span> arg1, <span class="hljs-keyword">int</span> arg2, Object obj)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Camera c = (Camera)((WeakReference)camera_ref).get();</span><br><span class="line">    <span class="hljs-keyword">if</span> (c == null)</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (c.mEventHandler != null) &#123;</span><br><span class="line">        Message m = c.mEventHandler.obtainMessage(what, arg1, arg2, obj);</span><br><span class="line">        c.mEventHandler.sendMessage(m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里也是采用了JAVA中很常用的handler message处理</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventHandler</span> <span class="hljs-title">extends</span> <span class="hljs-title">Handler</span></span></span><br><span class="line"><span class="hljs-class">&#123;</span></span><br><span class="line">    <span class="hljs-keyword">private</span> final Camera mCamera;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EventHandler</span><span class="hljs-params">(Camera c, Looper looper)</span> </span>&#123;</span><br><span class="line">        super(looper);</span><br><span class="line">        mCamera = c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleMessage</span><span class="hljs-params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">switch</span>(msg.what) &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_SHUTTER:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mShutterCallback != null) &#123;</span><br><span class="line">                mShutterCallback.onShutter();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_RAW_IMAGE:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mRawImageCallback != null) &#123;</span><br><span class="line">                mRawImageCallback.onPictureTaken((byte[])msg.obj, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_COMPRESSED_IMAGE:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mJpegCallback != null) &#123;</span><br><span class="line">                mJpegCallback.onPictureTaken((byte[])msg.obj, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_PREVIEW_FRAME:</span><br><span class="line">            PreviewCallback pCb = mPreviewCallback;</span><br><span class="line">            <span class="hljs-keyword">if</span> (pCb != null) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (mOneShot) &#123;</span><br><span class="line">                    <span class="hljs-comment">// Clear the callback variable before the callback</span></span><br><span class="line">                    <span class="hljs-comment">// in case the app calls setPreviewCallback from</span></span><br><span class="line">                    <span class="hljs-comment">// the callback function</span></span><br><span class="line">                    mPreviewCallback = null;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mWithBuffer) &#123;</span><br><span class="line">                    <span class="hljs-comment">// We're faking the camera preview mode to prevent</span></span><br><span class="line">                    <span class="hljs-comment">// the app from being flooded with preview frames.</span></span><br><span class="line">                    <span class="hljs-comment">// Set to oneshot mode again.</span></span><br><span class="line">                    setHasPreviewCallback(<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                pCb.onPreviewFrame((byte[])msg.obj, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_POSTVIEW_FRAME:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mPostviewCallback != null) &#123;</span><br><span class="line">                mPostviewCallback.onPictureTaken((byte[])msg.obj, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_FOCUS:</span><br><span class="line">            AutoFocusCallback cb = null;</span><br><span class="line">            synchronized (mAutoFocusCallbackLock) &#123;</span><br><span class="line">                cb = mAutoFocusCallback;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> (cb != null) &#123;</span><br><span class="line">                boolean success = msg.arg1 == <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;</span><br><span class="line">                cb.onAutoFocus(success, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_ZOOM:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mZoomListener != null) &#123;</span><br><span class="line">                mZoomListener.onZoomChange(msg.arg1, msg.arg2 != <span class="hljs-number">0</span>, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_PREVIEW_METADATA:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mFaceListener != null) &#123;</span><br><span class="line">                mFaceListener.onFaceDetection((Face[])msg.obj, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_ERROR :</span><br><span class="line">            Log.e(TAG, <span class="hljs-string">"Error "</span> + msg.arg1);</span><br><span class="line">            <span class="hljs-keyword">if</span> (mErrorCallback != null) &#123;</span><br><span class="line">                mErrorCallback.onError(msg.arg1, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_MSG_FOCUS_MOVE:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mAutoFocusMoveCallback != null) &#123;</span><br><span class="line">                mAutoFocusMoveCallback.onAutoFocusMoving(msg.arg1 == <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>, mCamera);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">default</span>:</span><br><span class="line">            Log.e(TAG, <span class="hljs-string">"Unknown message type "</span> + msg.what);</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 到这里基本上就是上层的处理了，callback都是在相机应用中设置的，然后各种数据就在相机应用中得到对应的处理。</p>
<p> 具体的每一个数据怎么处理，这里我们不做分析，后续有需要，可以在细讲一下，旨在弄清楚代码是怎么走的。</p>
<p> 本文中代码使用的是Android5.1原始代码，欢迎大家留言交流。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2015-08-23T14:37:49.000Z">2015-08-23</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    21 分钟 读完 (大约 3154 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2015/08/23/《Android Framework 之路》Android5.1 Camera Framework（二）/">《Android Framework 之路》Android5.1 Camera Framework（二）</a>
            
        </h1>
        <div class="content">
            <blockquote>
<p>上一次讲解了一下CameraService的启动过程，今天梳理一下Camera预览的过程</p>
</blockquote>
<h2 id="tartPreview过程"><a href="#tartPreview过程" class="headerlink" title="tartPreview过程"></a>tartPreview过程</h2><p> 首先，我们还是从应用层的使用入手<br> Camera.java (packages\apps\legacycamera\src\com\android\camera)</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread mCameraPreviewThread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        initializeCapabilities(); <span class="hljs-comment">//初始化参数</span></span><br><span class="line">        startPreview(); <span class="hljs-comment">//启动预览</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p> 针对相机应用，采用了单独的线程来处理预览，猜测是为了加快预览显示的速度</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startPreview</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="hljs-comment">// If we're previewing already, stop the preview first (this will blank</span></span><br><span class="line">        <span class="hljs-comment">// the screen).</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (mCameraState != PREVIEW_STOPPED) stopPreview();</span><br><span class="line"></span><br><span class="line">        setPreviewDisplay(mSurfaceHolder); <span class="hljs-comment">//设置SurfaceHolder</span></span><br><span class="line">        setDisplayOrientation();       <span class="hljs-comment">//设置显示方向</span></span><br><span class="line">        ......</span><br><span class="line">        setCameraParameters(UPDATE_PARAM_ALL); <span class="hljs-comment">//设置参数</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Inform the mainthread to go on the UI initialization.</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (mCameraPreviewThread != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">synchronized</span> (mCameraPreviewThread) &#123;</span><br><span class="line">                mCameraPreviewThread.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            Log.v(TAG, <span class="hljs-string">"startPreview"</span>);</span><br><span class="line">            mCameraDevice.startPreview(); <span class="hljs-comment">//启动预览，若失败，关闭Camera</span></span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            closeCamera();</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"startPreview failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> 这里就是APP中启动预览的过程，过程必然会是<br> java -&gt; JNI -&gt; cpp，<br> 然后通过Binder机制执行到CameraClient中的<br> CameraClient.cpp (av\services\camera\libcameraservice\api1)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> CameraClient::startPreview() &#123;</span><br><span class="line">    LOG1(<span class="hljs-string">"startPreview (pid %d)"</span>, getCallingPid());</span><br><span class="line">    <span class="hljs-keyword">return</span> startCameraMode(CAMERA_PREVIEW_MODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里传入的是CAMERA_PREVIEW_MODE，枚举类型是在CameraClient.h中定义的<br> // camera operation mode<br> enum camera_mode {<br> CAMERA_PREVIEW_MODE = 0, // frame automatically released<br> CAMERA_RECORDING_MODE = 1, // frame has to be explicitly released by releaseRecordingFrame()<br> };<br> 第一种是针对普通的预览，第二种是针对录像</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// start preview or recording</span></span><br><span class="line"><span class="hljs-keyword">status_t</span> CameraClient::startCameraMode(camera_mode mode) &#123;</span><br><span class="line">    LOG1(<span class="hljs-string">"startCameraMode(%d)"</span>, mode);</span><br><span class="line">    Mutex::<span class="hljs-function">Autolock <span class="hljs-title">lock</span><span class="hljs-params">(mLock)</span></span>;</span><br><span class="line">    <span class="hljs-keyword">status_t</span> result = checkPidAndHardware();</span><br><span class="line">    <span class="hljs-keyword">if</span> (result != NO_ERROR) <span class="hljs-keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">switch</span>(mode) &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_PREVIEW_MODE:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mSurface == <span class="hljs-number">0</span> &amp;&amp; mPreviewWindow == <span class="hljs-number">0</span>) &#123; </span><br><span class="line">                LOG1(<span class="hljs-string">"mSurface is not set yet."</span>);</span><br><span class="line">                <span class="hljs-comment">// still able to start preview in this case.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> startPreviewMode(); <span class="hljs-comment">//开始预览模式</span></span><br><span class="line">        <span class="hljs-keyword">case</span> CAMERA_RECORDING_MODE:</span><br><span class="line">            <span class="hljs-keyword">if</span> (mSurface == <span class="hljs-number">0</span> &amp;&amp; mPreviewWindow == <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                ALOGE(<span class="hljs-string">"mSurface or mPreviewWindow must be set before startRecordingMode."</span>);</span><br><span class="line">                <span class="hljs-keyword">return</span> INVALID_OPERATION;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> startRecordingMode(); <span class="hljs-comment">//开始录像模式</span></span><br><span class="line">        <span class="hljs-keyword">default</span>:</span><br><span class="line">            <span class="hljs-keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里我们走的是预览模式</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> CameraClient::startPreviewMode() &#123;</span><br><span class="line">    LOG1(<span class="hljs-string">"startPreviewMode"</span>); <span class="hljs-comment">//LOG1,一直忘记说了，这是有log开关用过setprop可以使用</span></span><br><span class="line">    <span class="hljs-keyword">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// if preview has been enabled, nothing needs to be done</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (mHardware-&gt;previewEnabled()) &#123; <span class="hljs-comment">//如果已经启动预览，不必重复</span></span><br><span class="line">        <span class="hljs-keyword">return</span> NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (mPreviewWindow != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">//适配显示窗口的大小</span></span><br><span class="line">        native_window_set_scaling_mode(mPreviewWindow.get(),</span><br><span class="line">                NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW);</span><br><span class="line">        <span class="hljs-comment">//调整帧数据的方向</span></span><br><span class="line">        native_window_set_buffers_transform(mPreviewWindow.get(),</span><br><span class="line">                mOrientation);</span><br><span class="line">    &#125;</span><br><span class="line">    mHardware-&gt;setPreviewWindow(mPreviewWindow); <span class="hljs-comment">//设置mPreviewWindow为显示窗口</span></span><br><span class="line">    result = mHardware-&gt;startPreview();   <span class="hljs-comment">//HAL层启动预览</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> result; <span class="hljs-comment">//返回结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里面涉及到native_window_set_scaling_mode，native_window_set_buffers_transform，直接跟代码，看注释就可以理解，这部分涉及到显示的一些内容，这里暂时不做讲解，native_window_set_scaling_mode设置模式为NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW，native_window_set_buffers_transform是用来调整方向。<br> 这里有一个问题，mPreviewWindow是从何而来的呢？<br> 还记得我们在应用层的startPreview()方法中会有这么一个过程</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setPreviewDisplay(mSurfaceHolder);</span><br><span class="line">setDisplayOrientation();</span><br></pre></td></tr></table></figure>

<p> 这里的setPreviewDisplay(mSurfaceHolder)，中间的过程大家可以自己跟一下，最后会执行到</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> CameraClient::setPreviewTarget(</span><br><span class="line">        <span class="hljs-keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer) &#123;</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;IBinder&gt; binder;</span><br><span class="line">    sp&lt;ANativeWindow&gt; window;</span><br><span class="line">    <span class="hljs-keyword">if</span> (bufferProducer != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        binder = bufferProducer-&gt;asBinder();</span><br><span class="line">        <span class="hljs-comment">// Using controlledByApp flag to ensure that the buffer queue remains in</span></span><br><span class="line">        <span class="hljs-comment">// async mode for the old camera API, where many applications depend</span></span><br><span class="line">        <span class="hljs-comment">// on that behavior.</span></span><br><span class="line">        window = <span class="hljs-keyword">new</span> Surface(bufferProducer, <span class="hljs-comment">/*controlledByApp*/</span> <span class="hljs-literal">true</span>); <span class="hljs-comment">//这个家伙</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> setPreviewWindow(binder, window);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">status_t</span> CameraClient::setPreviewWindow(<span class="hljs-keyword">const</span> sp&lt;IBinder&gt;&amp; binder,</span><br><span class="line">        <span class="hljs-keyword">const</span> sp&lt;ANativeWindow&gt;&amp; window) &#123;</span><br><span class="line">    Mutex::<span class="hljs-function">Autolock <span class="hljs-title">lock</span><span class="hljs-params">(mLock)</span></span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="hljs-keyword">if</span> (window != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        result = native_window_api_connect(window.get(), NATIVE_WINDOW_API_CAMERA);</span><br><span class="line">        <span class="hljs-keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">            ALOGE(<span class="hljs-string">"native_window_api_connect failed: %s (%d)"</span>, strerror(-result),</span><br><span class="line">                    result);</span><br><span class="line">            <span class="hljs-keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// If preview has been already started, register preview buffers now.</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (mHardware-&gt;previewEnabled()) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (window != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">            native_window_set_scaling_mode(window.get(),</span><br><span class="line">                    NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW);</span><br><span class="line">            native_window_set_buffers_transform(window.get(), mOrientation);</span><br><span class="line">            result = mHardware-&gt;setPreviewWindow(window);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (result == NO_ERROR) &#123;</span><br><span class="line">        <span class="hljs-comment">// Everything has succeeded.  Disconnect the old window and remember the</span></span><br><span class="line">        <span class="hljs-comment">// new window.</span></span><br><span class="line">        disconnectWindow(mPreviewWindow);</span><br><span class="line">        mSurface = binder;</span><br><span class="line">        mPreviewWindow = window; <span class="hljs-comment">//这里便是赋值的操作了，后面我们操作的mPreviewWindow </span></span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Something went wrong after we connected to the new window, so</span></span><br><span class="line">        <span class="hljs-comment">// disconnect here.</span></span><br><span class="line">        disconnectWindow(window);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 是不是看的很眼熟，和startPreviewMode()的过程有点相似。这就是mPreviewWindow的赋值过程。<br> 回到setPreviewMode()函数中，其中主要的过程是这两个<br> mHardware-&gt;setPreviewWindow(mPreviewWindow);<br> result = mHardware-&gt;startPreview();<br> 这里都是HAL层的处理，将窗口传下去，然后启动预览，最后数据就可以投射到这个预览窗口上了。<br> 我们继续往下看一下，<br> CameraHardwareInterface.h (av\services\camera\libcameraservice\device1)</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/** Set the ANativeWindow to which preview frames are sent */</span></span><br><span class="line"><span class="hljs-keyword">status_t</span> setPreviewWindow(<span class="hljs-keyword">const</span> sp&lt;ANativeWindow&gt;&amp; buf)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="hljs-string">"%s(%s) buf %p"</span>, __FUNCTION__, mName.<span class="hljs-built_in">string</span>(), buf.get());</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (mDevice-&gt;ops-&gt;set_preview_window) &#123;</span><br><span class="line">        mPreviewWindow = buf;</span><br><span class="line">        mHalPreviewWindow.user = <span class="hljs-keyword">this</span>;</span><br><span class="line">        ALOGV(<span class="hljs-string">"%s &amp;mHalPreviewWindow %p mHalPreviewWindow.user %p"</span>, __FUNCTION__,</span><br><span class="line">                &amp;mHalPreviewWindow, mHalPreviewWindow.user);</span><br><span class="line">        <span class="hljs-keyword">return</span> mDevice-&gt;ops-&gt;set_preview_window(mDevice,</span><br><span class="line">                buf.get() ? &amp;mHalPreviewWindow.nw : <span class="hljs-number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> INVALID_OPERATION;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Start preview mode.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-keyword">status_t</span> startPreview()</span><br><span class="line"> &#123;</span><br><span class="line">     ALOGV(<span class="hljs-string">"%s(%s)"</span>, __FUNCTION__, mName.<span class="hljs-built_in">string</span>());</span><br><span class="line">     <span class="hljs-keyword">if</span> (mDevice-&gt;ops-&gt;start_preview)</span><br><span class="line">         <span class="hljs-keyword">return</span> mDevice-&gt;ops-&gt;start_preview(mDevice);</span><br><span class="line">     <span class="hljs-keyword">return</span> INVALID_OPERATION;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p> 这是一个空壳，我们去看具体的实现，这里我们看下android5.1源码中Qcom的实现，由于针对HAL层的不同厂商有不同的处理方式，在这里我们就随便找个目录下的进行分析，旨在看流程，理解一些基础的内容，<br> QCamera2Hal.cpp （\device\asus\flo\camera\qcamera2\hal）</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"QCamera2Factory.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">hw_module_t</span> camera_common = &#123;</span><br><span class="line">    tag: HARDWARE_MODULE_TAG,</span><br><span class="line">    module_api_version: CAMERA_MODULE_API_VERSION_1_0,</span><br><span class="line">    hal_api_version: HARDWARE_HAL_API_VERSION,</span><br><span class="line">    id: CAMERA_HARDWARE_MODULE_ID,</span><br><span class="line">    name: <span class="hljs-string">"QCamera Module"</span>,</span><br><span class="line">    author: <span class="hljs-string">"Qualcomm Innovation Center Inc"</span>,</span><br><span class="line">    methods: &amp;qcamera::QCamera2Factory::mModuleMethods,</span><br><span class="line">    dso: <span class="hljs-literal">NULL</span>,</span><br><span class="line">    reserved:  &#123;<span class="hljs-number">0</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">camera_module_t</span> HAL_MODULE_INFO_SYM = &#123;</span><br><span class="line">    common: camera_common,</span><br><span class="line">    get_number_of_cameras: qcamera::QCamera2Factory::get_number_of_cameras,</span><br><span class="line">    get_camera_info: qcamera::QCamera2Factory::get_camera_info,</span><br><span class="line">    set_callbacks: <span class="hljs-literal">NULL</span>,</span><br><span class="line">    get_vendor_tag_ops: <span class="hljs-literal">NULL</span>,</span><br><span class="line">    open_legacy: <span class="hljs-literal">NULL</span>,</span><br><span class="line">    reserved: &#123;<span class="hljs-number">0</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> 这里提一下HAL_MODULE_INFO_SYM这个东西，本身就是一个定义在hardware.h下的一个宏，看注释，意思很明显</p>
<figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">define HAL_MODULE_INFO_SYM HMI </span><br><span class="line"><span class="hljs-comment">//.so中将一个符号HMI,获取此符号的地址，就获取到了对应的hw_module_t地址</span></span><br></pre></td></tr></table></figure>

<p> HAL_MODULE_INFO_SYM，这个是HAL 编译生成的so的入口，CameraService会获取这个来操作so<br> camera_common是针对HAL规范定义的一些内容。<br> Camera的open指向的是&amp;qcamera::QCamera2Factory::mModuleMethods中的open方法，如下</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hw_module_methods_t</span> <span class="hljs-title">QCamera2Factory</span>:</span>:mModuleMethods = &#123;</span><br><span class="line">    open: QCamera2Factory::camera_device_open,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> 这个方法中打开设备节点，我们可以看到HAL层中open的过程是很有讲究的，也不能这么说，应为HAL的处理方式基本上都是如此。</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> QCamera2Factory::camera_device_open(</span><br><span class="line">    <span class="hljs-keyword">const</span> struct <span class="hljs-keyword">hw_module_t</span> *<span class="hljs-keyword">module</span>, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *id,</span><br><span class="line">    struct <span class="hljs-keyword">hw_device_t</span> **hw_device)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> != &amp;HAL_MODULE_INFO_SYM.common) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"Invalid module. Trying to open %p, expect %p"</span>,</span><br><span class="line">            <span class="hljs-keyword">module</span>, &amp;HAL_MODULE_INFO_SYM.common);</span><br><span class="line">        <span class="hljs-keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!id) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"Invalid camera id"</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> gQCamera2Factory.cameraDeviceOpen(atoi(id), hw_device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> QCamera2Factory::cameraDeviceOpen(<span class="hljs-keyword">int</span> camera_id,</span><br><span class="line">                    struct <span class="hljs-keyword">hw_device_t</span> **hw_device)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> rc = NO_ERROR;</span><br><span class="line">    <span class="hljs-keyword">if</span> (camera_id &lt; <span class="hljs-number">0</span> || camera_id &gt;= mNumOfCameras)</span><br><span class="line">        <span class="hljs-keyword">return</span> BAD_VALUE;</span><br><span class="line">    <span class="hljs-comment">//到这里才是真正的HAL层的创建，可见HAL层的创建和open操作是相关的</span></span><br><span class="line">    QCamera2HardwareInterface *hw = <span class="hljs-keyword">new</span> QCamera2HardwareInterface(camera_id);</span><br><span class="line">    <span class="hljs-keyword">if</span> (!hw) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"Allocation of hardware interface failed"</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    rc = hw-&gt;openCamera(hw_device);</span><br><span class="line">    <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">        <span class="hljs-keyword">delete</span> hw;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 之前在CameraService过程中提到的CameraHardwareInterface空壳就是为这个QCamera2HardwareInterface准备的，具体实现全部都在这个类中。<br> 关于QCamera2HardwareInterface的内容我们在后面会讲到，这里暂且先放一下，接着上面的<br> mHardware-&gt;setPreviewWindow(mPreviewWindow);<br> result = mHardware-&gt;startPreview();<br> 经过CameraHardwareInterface后<br> mDevice-&gt;ops-&gt;set_preview_window(mDevice, buf.get() ? &amp;mHalPreviewWindow.nw : 0);<br> mDevice-&gt;ops-&gt;start_preview(mDevice);<br> 然后经过QCamera2HardwareInterface中的mCameraOps函数指针对应表<br> set_preview_window: QCamera2HardwareInterface::set_preview_window<br> start_preview: QCamera2HardwareInterface::start_preview<br> 所以会调用到</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> QCamera2HardwareInterface::set_preview_window(struct camera_device *device,</span><br><span class="line">        struct preview_stream_ops *window)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> rc = NO_ERROR;</span><br><span class="line">    QCamera2HardwareInterface *hw =</span><br><span class="line">        <span class="hljs-keyword">reinterpret_cast</span>&lt;QCamera2HardwareInterface *&gt;(device-&gt;priv);</span><br><span class="line">    <span class="hljs-keyword">if</span> (!hw) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"%s: NULL camera device"</span>, __func__);</span><br><span class="line">        <span class="hljs-keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hw-&gt;lockAPI();</span><br><span class="line">    rc = hw-&gt;processAPI(QCAMERA_SM_EVT_SET_PREVIEW_WINDOW, (<span class="hljs-keyword">void</span> *)window);</span><br><span class="line">    <span class="hljs-keyword">if</span> (rc == NO_ERROR) &#123;</span><br><span class="line">        hw-&gt;waitAPIResult(QCAMERA_SM_EVT_SET_PREVIEW_WINDOW);</span><br><span class="line">        rc = hw-&gt;m_apiResult.status;</span><br><span class="line">    &#125;</span><br><span class="line">    hw-&gt;unlockAPI();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里会经过一轮状态机，暂时先不讲，然后执行到<br> int QCamera2HardwareInterface::setPreviewWindow(<br> struct preview_stream_ops <em>window)<br> {<br> mPreviewWindow = window;<br> return NO_ERROR;<br> }<br> 同理，startPreview也会执行到<br> int QCamera2HardwareInterface::startPreview()<br> {<br> int32_t rc = NO_ERROR;<br> ALOGD(“%s: E”, *</em>func<strong>);<br> // start preview stream<br> if (mParameters.isZSLMode() &amp;&amp; mParameters.getRecordingHintValue() !=true) {<br> rc = startChannel(QCAMERA_CH_TYPE_ZSL);<br> } else {<br> rc = startChannel(QCAMERA_CH_TYPE_PREVIEW);<br> }<br> ALOGD(“%s: X”, **func</strong>);<br> return rc;<br> }<br> 这里开启通道，可以理解成数据通道，ZSL是之前没有的，所谓ZSL就是触发拍照后不停止预览。<br> 这里看到会根据当前是都支持ZSL模式而进入不同的通道，我们这里就看QCAMERA_CH_TYPE_PREVIEW，startChannel</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int32_t</span> QCamera2HardwareInterface::startChannel(<span class="hljs-keyword">qcamera_ch_type_enum_t</span> ch_type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">int32_t</span> rc = UNKNOWN_ERROR;</span><br><span class="line">    <span class="hljs-keyword">if</span> (m_channels[ch_type] != <span class="hljs-literal">NULL</span>) &#123;</span><br><span class="line">        rc = m_channels[ch_type]-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> m_channels是不同的通道的实例的数组，这里如果没有PREVIEW的channel就直接return，岂不是无法启动预览，这个流程感觉有点不对劲。但是这整个过程跟下来也没有看到m_channels相关的初始化过程。</p>
<p> 这个问题出在我刚才从CameraHardwareInterface跟到QCamera2HardwareInterface的时候跳过的一个内容—–状态机，在状态机中会执行一个preparePreview()的操作</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int32_t</span> QCamera2HardwareInterface::preparePreview()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">int32_t</span> rc = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (mParameters.isZSLMode() &amp;&amp; mParameters.getRecordingHintValue() !=<span class="hljs-literal">true</span>) &#123;</span><br><span class="line">        rc = addChannel(QCAMERA_CH_TYPE_ZSL); <span class="hljs-comment">//这里我们就添加了一个channel,当然这里是ZSL的</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> rc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">bool</span> recordingHint = mParameters.getRecordingHintValue(); <span class="hljs-comment">//recording</span></span><br><span class="line">        <span class="hljs-keyword">if</span>(recordingHint) &#123;</span><br><span class="line">            rc = addChannel(QCAMERA_CH_TYPE_SNAPSHOT);  <span class="hljs-comment">//录像中是可以拍照的，需要snapshot channel</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> rc;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rc = addChannel(QCAMERA_CH_TYPE_VIDEO); <span class="hljs-comment">//video channel</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">                delChannel(QCAMERA_CH_TYPE_SNAPSHOT);</span><br><span class="line">                <span class="hljs-keyword">return</span> rc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rc = addChannel(QCAMERA_CH_TYPE_PREVIEW); <span class="hljs-comment">//添加preview  channel</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (recordingHint) &#123;</span><br><span class="line">                delChannel(QCAMERA_CH_TYPE_SNAPSHOT);</span><br><span class="line">                delChannel(QCAMERA_CH_TYPE_VIDEO);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> rc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 在addchannel()的过程中会根据不同的channel类型创建不同的实例，这里我们直接看从addChannel()转到的addPreviewChannel()函数</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int32_t</span> QCamera2HardwareInterface::addPreviewChannel()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">int32_t</span> rc = NO_ERROR;</span><br><span class="line">    QCameraChannel *pChannel = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">//初始化一个QCameraChanel，后面要使用</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (m_channels[QCAMERA_CH_TYPE_PREVIEW] != <span class="hljs-literal">NULL</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">// if we had preview channel before, delete it first</span></span><br><span class="line">        <span class="hljs-keyword">delete</span> m_channels[QCAMERA_CH_TYPE_PREVIEW]; <span class="hljs-comment">//如果之前preview channel存在，干掉</span></span><br><span class="line">        m_channels[QCAMERA_CH_TYPE_PREVIEW] = <span class="hljs-literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pChannel = <span class="hljs-keyword">new</span> QCameraChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">                                  mCameraHandle-&gt;ops); </span><br><span class="line">    <span class="hljs-comment">//new 一个新的channel</span></span><br><span class="line">    .....</span><br><span class="line">    <span class="hljs-comment">// meta data stream always coexists with preview if applicable</span></span><br><span class="line">    rc = addStreamToChannel(pChannel, CAM_STREAM_TYPE_METADATA,</span><br><span class="line">                            metadata_stream_cb_routine, <span class="hljs-keyword">this</span>);</span><br><span class="line">    <span class="hljs-comment">//添加metadata stream cb</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"%s: add metadata stream failed, ret = %d"</span>, __func__, rc);</span><br><span class="line">        <span class="hljs-keyword">delete</span> pChannel;</span><br><span class="line">        <span class="hljs-keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (isNoDisplayMode()) &#123; <span class="hljs-comment">//判断是否为不需要显示的模式</span></span><br><span class="line">        rc = addStreamToChannel(pChannel, CAM_STREAM_TYPE_PREVIEW,</span><br><span class="line">                                nodisplay_preview_stream_cb_routine, <span class="hljs-keyword">this</span>);</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-comment">//这里添加preview stream cb到channel中</span></span><br><span class="line">        rc = addStreamToChannel(pChannel, CAM_STREAM_TYPE_PREVIEW,</span><br><span class="line">                                preview_stream_cb_routine, <span class="hljs-keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (rc != NO_ERROR) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"%s: add preview stream failed, ret = %d"</span>, __func__, rc);</span><br><span class="line">        <span class="hljs-keyword">delete</span> pChannel;</span><br><span class="line">        <span class="hljs-keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_channels[QCAMERA_CH_TYPE_PREVIEW] = pChannel; <span class="hljs-comment">//维护m_channels数据</span></span><br><span class="line">    <span class="hljs-keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里注册的preview_stream_cb_routine回调，这之后的过程我们暂时先不去看，了解这部分之后，回到之前chanel 的start()，最后会执行到QCameraChannel::start()方法，这里往下的内容我们暂时不往下看，知道这个过程中会执行数据采集，然后返回给HAL层就行了，HAL针对底层返回的数据，我们在哪里获取，做什么对应的处理呢？找到之前注册的Callback.<br> QCamera2HWICallbacks.cpp (\device\asus\flo\camera\qcamera2\hal)</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">void</span> QCamera2HardwareInterface::preview_stream_cb_routine(<span class="hljs-keyword">mm_camera_super_buf_t</span> *super_frame,</span><br><span class="line">                                                          QCameraStream * stream,</span><br><span class="line">                                                          <span class="hljs-keyword">void</span> *userdata)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGD(<span class="hljs-string">"[KPI Perf] %s : BEGIN"</span>, __func__);</span><br><span class="line">    <span class="hljs-keyword">int</span> err = NO_ERROR;</span><br><span class="line">    QCamera2HardwareInterface *pme = (QCamera2HardwareInterface *)userdata;</span><br><span class="line">    QCameraGrallocMemory *memory = (QCameraGrallocMemory *)super_frame-&gt;bufs[<span class="hljs-number">0</span>]-&gt;mem_info;</span><br><span class="line">    ......</span><br><span class="line">    <span class="hljs-keyword">mm_camera_buf_def_t</span> *frame = super_frame-&gt;bufs[<span class="hljs-number">0</span>];</span><br><span class="line">    ......</span><br><span class="line">    <span class="hljs-keyword">if</span> (!pme-&gt;needProcessPreviewFrame()) &#123;</span><br><span class="line">        ALOGE(<span class="hljs-string">"%s: preview is not running, no need to process"</span>, __func__);</span><br><span class="line">        stream-&gt;bufDone(frame-&gt;buf_idx);</span><br><span class="line">        <span class="hljs-built_in">free</span>(super_frame);</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (pme-&gt;needDebugFps()) &#123;</span><br><span class="line">        pme-&gt;debugShowPreviewFPS();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">int</span> idx = frame-&gt;buf_idx;</span><br><span class="line">    pme-&gt;dumpFrameToFile(frame-&gt;buffer, frame-&gt;frame_len,</span><br><span class="line">                         frame-&gt;frame_idx, QCAMERA_DUMP_FRM_PREVIEW);</span><br><span class="line">    <span class="hljs-comment">//这里的注释很明显，displayer buffer而这个buffer就是我们需要投射到屏幕上的数据</span></span><br><span class="line">    <span class="hljs-comment">// Display the buffer.</span></span><br><span class="line">    <span class="hljs-keyword">int</span> dequeuedIdx = memory-&gt;displayBuffer(idx); <span class="hljs-comment">//这部分涉及到显示的过程，这里不做赘述</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (dequeuedIdx &lt; <span class="hljs-number">0</span> || dequeuedIdx &gt;= memory-&gt;getCnt()) &#123;</span><br><span class="line">        ALOGD(<span class="hljs-string">"%s: Invalid dequeued buffer index %d from display"</span>,</span><br><span class="line">              __func__, dequeuedIdx);</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Return dequeued buffer back to driver</span></span><br><span class="line">        err = stream-&gt;bufDone(dequeuedIdx);</span><br><span class="line">        <span class="hljs-keyword">if</span> ( err &lt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="hljs-string">"stream bufDone failed %d"</span>, err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">//针对上层设置的datacallback过程做些处理</span></span><br><span class="line">    <span class="hljs-comment">// Handle preview data callback</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (pme-&gt;mDataCb != <span class="hljs-literal">NULL</span> &amp;&amp; pme-&gt;msgTypeEnabledWithLock(CAMERA_MSG_PREVIEW_FRAME) &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="hljs-keyword">qcamera_callback_argm_t</span> cbArg;</span><br><span class="line">        <span class="hljs-built_in">memset</span>(&amp;cbArg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">qcamera_callback_argm_t</span>));</span><br><span class="line">        cbArg.cb_type = QCAMERA_DATA_CALLBACK;</span><br><span class="line">        cbArg.msg_type = CAMERA_MSG_PREVIEW_FRAME;</span><br><span class="line">        cbArg.data = data;</span><br><span class="line">        <span class="hljs-keyword">if</span> ( previewMem ) &#123;</span><br><span class="line">            cbArg.user_data = previewMem;</span><br><span class="line">            cbArg.release_cb = releaseCameraMemory;</span><br><span class="line">        &#125;</span><br><span class="line">        cbArg.cookie = pme;</span><br><span class="line">        pme-&gt;m_cbNotifier.notifyCallback(cbArg); <span class="hljs-comment">//封装完之后往上甩</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">free</span>(super_frame);</span><br><span class="line">    ALOGD(<span class="hljs-string">"[KPI Perf] %s : END"</span>, __func__);</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这就是在addPreviewChannel的过程中添加的preview stream callback，当然还有metadata的，暂时先看preview的这个。这里面作的操作就是显示预览数据到窗口中，然后对设置下面的preview callback做对应的callback处理.</p>
<p> 讲到这里，Camera的预览过程基本上就结束了，关于底层如果采集数据以及HAL中一些其他的内容，在这里没有讲解，主要是要理解这个过程，之后再每一个过程中在往下学习。</p>
<p> 本文中代码使用的是Android5.1原始代码，欢迎大家留言交流。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2015-08-15T14:24:43.000Z">2015-08-15</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Android源码/">Android源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13 分钟 读完 (大约 1967 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2015/08/15/《Android Framework 之路》Android5.1 Camera Framework（一）/">《Android Framework 之路》Android5.1 Camera Framework（一）</a>
            
        </h1>
        <div class="content">
            <h2 id="Android5-0-Camera-Framework-简介"><a href="#Android5-0-Camera-Framework-简介" class="headerlink" title="Android5.0 Camera Framework 简介"></a>Android5.0 Camera Framework 简介</h2><h3 id="CameraService启动"><a href="#CameraService启动" class="headerlink" title="CameraService启动"></a>CameraService启动</h3><p>CameraService是在MediaServer启动过程中进行的<br>main_mediaserver.cpp (frameworks\av\media\mediaserver)</p>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                <a class="button is-size-7 is-light" href="/2015/08/15/《Android Framework 之路》Android5.1 Camera Framework（一）/#more">阅读更多</a>
                </div>
            </div>
        </div>
        
        
    </div>
</div>








</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="Your name">
                    
                    
                    <p class="is-size-4 is-block">
                        Your name
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Your title
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Your location</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        162
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        14
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        81
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ppoffice" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/ppoffice">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/ppoffice" target="_blank">
                    <span class="level-left">
                        <span class="level-item">PPOffice</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Android基础/">
            <span class="level-start">
                <span class="level-item">Android基础</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">51</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Android基础/Android-Studio/">
            <span class="level-start">
                <span class="level-item">Android Studio</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Android安全/">
            <span class="level-start">
                <span class="level-item">Android安全</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Android应用/">
            <span class="level-start">
                <span class="level-item">Android应用</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">25</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Android开源库/">
            <span class="level-start">
                <span class="level-item">Android开源库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">24</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Android源码/">
            <span class="level-start">
                <span class="level-item">Android源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">10</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Android系统/">
            <span class="level-start">
                <span class="level-item">Android系统</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Android进阶/">
            <span class="level-start">
                <span class="level-item">Android进阶</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Angular/">
            <span class="level-start">
                <span class="level-item">Angular</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Flutter/">
            <span class="level-start">
                <span class="level-item">Flutter</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Kotlin/">
            <span class="level-start">
                <span class="level-item">Kotlin</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/LeetCode/">
            <span class="level-start">
                <span class="level-item">LeetCode</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/微信小程序/">
            <span class="level-start">
                <span class="level-item">微信小程序</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/运维/">
            <span class="level-start">
                <span class="level-item">运维</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">13</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Aandroid实战/" style="font-size: 10px;">Aandroid实战</a> <a href="/tags/Android-Studio/" style="font-size: 13.08px;">Android Studio</a> <a href="/tags/Android基础/" style="font-size: 10px;">Android基础</a> <a href="/tags/Android实战/" style="font-size: 19.23px;">Android实战</a> <a href="/tags/Android开源库/" style="font-size: 10.77px;">Android开源库</a> <a href="/tags/Android源码/" style="font-size: 10px;">Android源码</a> <a href="/tags/Angular/" style="font-size: 10px;">Angular</a> <a href="/tags/BroadcastReceiver/" style="font-size: 10px;">BroadcastReceiver</a> <a href="/tags/CSDN迁移/" style="font-size: 13.08px;">CSDN迁移</a> <a href="/tags/CentOS/" style="font-size: 11.54px;">CentOS</a> <a href="/tags/CodeStyle/" style="font-size: 10px;">CodeStyle</a> <a href="/tags/Docker/" style="font-size: 12.31px;">Docker</a> <a href="/tags/Drawable/" style="font-size: 10.77px;">Drawable</a> <a href="/tags/EditText/" style="font-size: 10px;">EditText</a> <a href="/tags/FileProvider/" style="font-size: 10px;">FileProvider</a> <a href="/tags/Flex/" style="font-size: 10px;">Flex</a> <a href="/tags/Flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/Fragment/" style="font-size: 12.31px;">Fragment</a> <a href="/tags/Framework/" style="font-size: 15.38px;">Framework</a> <a href="/tags/Gank-io/" style="font-size: 12.31px;">Gank.io</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/HAL/" style="font-size: 10px;">HAL</a> <a href="/tags/IDEA插件/" style="font-size: 10px;">IDEA插件</a> <a href="/tags/JetPack/" style="font-size: 10px;">JetPack</a> <a href="/tags/Kotlin/" style="font-size: 13.85px;">Kotlin</a> <a href="/tags/LeetCode/" style="font-size: 12.31px;">LeetCode</a> <a href="/tags/Linux/" style="font-size: 13.85px;">Linux</a> <a href="/tags/MPAndroidChart/" style="font-size: 14.62px;">MPAndroidChart</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/MultiDex/" style="font-size: 10px;">MultiDex</a> <a href="/tags/Mysql/" style="font-size: 10.77px;">Mysql</a> <a href="/tags/PMDReader/" style="font-size: 10px;">PMDReader</a> <a href="/tags/Picasso/" style="font-size: 10px;">Picasso</a> <a href="/tags/PowerDesign/" style="font-size: 10px;">PowerDesign</a> <a href="/tags/Realm/" style="font-size: 16.15px;">Realm</a> <a href="/tags/RecyclerView/" style="font-size: 11.54px;">RecyclerView</a> <a href="/tags/Retrofit/" style="font-size: 10px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10.77px;">RxJava</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/Smali/" style="font-size: 10.77px;">Smali</a> <a href="/tags/TabLayout/" style="font-size: 10px;">TabLayout</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/View/" style="font-size: 10px;">View</a> <a href="/tags/WanANdroid/" style="font-size: 10px;">WanANdroid</a> <a href="/tags/WebService/" style="font-size: 10px;">WebService</a> <a href="/tags/Xen/" style="font-size: 11.54px;">Xen</a> <a href="/tags/allowBackup/" style="font-size: 10px;">allowBackup</a> <a href="/tags/事件分发/" style="font-size: 10px;">事件分发</a> <a href="/tags/动画/" style="font-size: 10.77px;">动画</a> <a href="/tags/四大组件/" style="font-size: 10px;">四大组件</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/局域网/" style="font-size: 10px;">局域网</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/布局控件/" style="font-size: 20px;">布局控件</a> <a href="/tags/应用/" style="font-size: 17.69px;">应用</a> <a href="/tags/开发问题/" style="font-size: 10px;">开发问题</a> <a href="/tags/开机动画/" style="font-size: 10.77px;">开机动画</a> <a href="/tags/开源/" style="font-size: 11.54px;">开源</a> <a href="/tags/开源库/" style="font-size: 18.46px;">开源库</a> <a href="/tags/微信公众号/" style="font-size: 10px;">微信公众号</a> <a href="/tags/快捷键/" style="font-size: 10px;">快捷键</a> <a href="/tags/手电筒/" style="font-size: 10px;">手电筒</a> <a href="/tags/技术选型/" style="font-size: 10px;">技术选型</a> <a href="/tags/文本/" style="font-size: 10px;">文本</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a> <a href="/tags/源码分析/" style="font-size: 11.54px;">源码分析</a> <a href="/tags/百度地图/" style="font-size: 12.31px;">百度地图</a> <a href="/tags/系统源码/" style="font-size: 10px;">系统源码</a> <a href="/tags/终端/" style="font-size: 10px;">终端</a> <a href="/tags/聚合数据/" style="font-size: 10px;">聚合数据</a> <a href="/tags/自定义View/" style="font-size: 15.38px;">自定义View</a> <a href="/tags/虚拟化/" style="font-size: 11.54px;">虚拟化</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/译文/" style="font-size: 16.92px;">译文</a> <a href="/tags/贪吃蛇/" style="font-size: 10px;">贪吃蛇</a> <a href="/tags/资源/" style="font-size: 10px;">资源</a> <a href="/tags/资源配置/" style="font-size: 10px;">资源配置</a> <a href="/tags/辅助工具/" style="font-size: 10px;">辅助工具</a> <a href="/tags/配置/" style="font-size: 11.54px;">配置</a> <a href="/tags/问题/" style="font-size: 10px;">问题</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（五）》MVVM/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.040Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（五）》MVVM/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十五）》Frame Animation/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.039Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十五）》Frame Animation/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十）》 CoordinatorLayout Behavior/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.039Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十）》 CoordinatorLayout Behavior/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十一）》Android 屏幕适配/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.037Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十一）》Android 屏幕适配/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十七）》 Android Studio常用技巧（免费代理下载Google内容）/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.037Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十七）》 Android Studio常用技巧（免费代理下载Google内容）/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">8</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/04/">
                <span class="level-start">
                    <span class="level-item">四月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">11</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/02/">
                <span class="level-start">
                    <span class="level-item">二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">8</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">8</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/04/">
                <span class="level-start">
                    <span class="level-item">四月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Aandroid实战/">
                        <span class="tag">Aandroid实战</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android-Studio/">
                        <span class="tag">Android Studio</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android基础/">
                        <span class="tag">Android基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android实战/">
                        <span class="tag">Android实战</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android开源库/">
                        <span class="tag">Android开源库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android源码/">
                        <span class="tag">Android源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Angular/">
                        <span class="tag">Angular</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BroadcastReceiver/">
                        <span class="tag">BroadcastReceiver</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CSDN迁移/">
                        <span class="tag">CSDN迁移</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CentOS/">
                        <span class="tag">CentOS</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CodeStyle/">
                        <span class="tag">CodeStyle</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Docker/">
                        <span class="tag">Docker</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Drawable/">
                        <span class="tag">Drawable</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/EditText/">
                        <span class="tag">EditText</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/FileProvider/">
                        <span class="tag">FileProvider</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Flex/">
                        <span class="tag">Flex</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Flutter/">
                        <span class="tag">Flutter</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Fragment/">
                        <span class="tag">Fragment</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Framework/">
                        <span class="tag">Framework</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Gank-io/">
                        <span class="tag">Gank.io</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Gitlab/">
                        <span class="tag">Gitlab</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HAL/">
                        <span class="tag">HAL</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/IDEA插件/">
                        <span class="tag">IDEA插件</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JetPack/">
                        <span class="tag">JetPack</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Kotlin/">
                        <span class="tag">Kotlin</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LeetCode/">
                        <span class="tag">LeetCode</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MPAndroidChart/">
                        <span class="tag">MPAndroidChart</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MacOS/">
                        <span class="tag">MacOS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Markdown/">
                        <span class="tag">Markdown</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MultiDex/">
                        <span class="tag">MultiDex</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mysql/">
                        <span class="tag">Mysql</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/PMDReader/">
                        <span class="tag">PMDReader</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Picasso/">
                        <span class="tag">Picasso</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/PowerDesign/">
                        <span class="tag">PowerDesign</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Realm/">
                        <span class="tag">Realm</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RecyclerView/">
                        <span class="tag">RecyclerView</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Retrofit/">
                        <span class="tag">Retrofit</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RxJava/">
                        <span class="tag">RxJava</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Service/">
                        <span class="tag">Service</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Smali/">
                        <span class="tag">Smali</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/TabLayout/">
                        <span class="tag">TabLayout</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/View/">
                        <span class="tag">View</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/WanANdroid/">
                        <span class="tag">WanANdroid</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/WebService/">
                        <span class="tag">WebService</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Xen/">
                        <span class="tag">Xen</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/allowBackup/">
                        <span class="tag">allowBackup</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/事件分发/">
                        <span class="tag">事件分发</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动画/">
                        <span class="tag">动画</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/四大组件/">
                        <span class="tag">四大组件</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/局域网/">
                        <span class="tag">局域网</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/布局控件/">
                        <span class="tag">布局控件</span>
                        <span class="tag is-grey">28</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/应用/">
                        <span class="tag">应用</span>
                        <span class="tag is-grey">23</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开发问题/">
                        <span class="tag">开发问题</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开机动画/">
                        <span class="tag">开机动画</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源/">
                        <span class="tag">开源</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源库/">
                        <span class="tag">开源库</span>
                        <span class="tag is-grey">24</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/微信公众号/">
                        <span class="tag">微信公众号</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/快捷键/">
                        <span class="tag">快捷键</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手电筒/">
                        <span class="tag">手电筒</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/技术选型/">
                        <span class="tag">技术选型</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/文本/">
                        <span class="tag">文本</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/框架/">
                        <span class="tag">框架</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码分析/">
                        <span class="tag">源码分析</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/百度地图/">
                        <span class="tag">百度地图</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/系统源码/">
                        <span class="tag">系统源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/终端/">
                        <span class="tag">终端</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/聚合数据/">
                        <span class="tag">聚合数据</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/自定义View/">
                        <span class="tag">自定义View</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟化/">
                        <span class="tag">虚拟化</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/译文/">
                        <span class="tag">译文</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪吃蛇/">
                        <span class="tag">贪吃蛇</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/资源/">
                        <span class="tag">资源</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/资源配置/">
                        <span class="tag">资源配置</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/辅助工具/">
                        <span class="tag">辅助工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/配置/">
                        <span class="tag">配置</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/问题/">
                        <span class="tag">问题</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（五）》MVVM/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.040Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（五）》MVVM/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十五）》Frame Animation/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.039Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十五）》Frame Animation/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十）》 CoordinatorLayout Behavior/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.039Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十）》 CoordinatorLayout Behavior/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十一）》Android 屏幕适配/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.037Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十一）》Android 屏幕适配/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/06/14/《Android 基础（二十七）》 Android Studio常用技巧（免费代理下载Google内容）/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-14T11:22:12.037Z">2019-06-14</time></div>
                    <a href="/2019/06/14/《Android 基础（二十七）》 Android Studio常用技巧（免费代理下载Google内容）/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">8</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/04/">
                <span class="level-start">
                    <span class="level-item">四月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">11</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/02/">
                <span class="level-start">
                    <span class="level-item">二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">8</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">8</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/04/">
                <span class="level-start">
                    <span class="level-item">四月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Aandroid实战/">
                        <span class="tag">Aandroid实战</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android-Studio/">
                        <span class="tag">Android Studio</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android基础/">
                        <span class="tag">Android基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android实战/">
                        <span class="tag">Android实战</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android开源库/">
                        <span class="tag">Android开源库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android源码/">
                        <span class="tag">Android源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Angular/">
                        <span class="tag">Angular</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BroadcastReceiver/">
                        <span class="tag">BroadcastReceiver</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CSDN迁移/">
                        <span class="tag">CSDN迁移</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CentOS/">
                        <span class="tag">CentOS</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CodeStyle/">
                        <span class="tag">CodeStyle</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Docker/">
                        <span class="tag">Docker</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Drawable/">
                        <span class="tag">Drawable</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/EditText/">
                        <span class="tag">EditText</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/FileProvider/">
                        <span class="tag">FileProvider</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Flex/">
                        <span class="tag">Flex</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Flutter/">
                        <span class="tag">Flutter</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Fragment/">
                        <span class="tag">Fragment</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Framework/">
                        <span class="tag">Framework</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Gank-io/">
                        <span class="tag">Gank.io</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Gitlab/">
                        <span class="tag">Gitlab</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HAL/">
                        <span class="tag">HAL</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/IDEA插件/">
                        <span class="tag">IDEA插件</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JetPack/">
                        <span class="tag">JetPack</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Kotlin/">
                        <span class="tag">Kotlin</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LeetCode/">
                        <span class="tag">LeetCode</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MPAndroidChart/">
                        <span class="tag">MPAndroidChart</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MacOS/">
                        <span class="tag">MacOS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Markdown/">
                        <span class="tag">Markdown</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MultiDex/">
                        <span class="tag">MultiDex</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mysql/">
                        <span class="tag">Mysql</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/PMDReader/">
                        <span class="tag">PMDReader</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Picasso/">
                        <span class="tag">Picasso</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/PowerDesign/">
                        <span class="tag">PowerDesign</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Realm/">
                        <span class="tag">Realm</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RecyclerView/">
                        <span class="tag">RecyclerView</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Retrofit/">
                        <span class="tag">Retrofit</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RxJava/">
                        <span class="tag">RxJava</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Service/">
                        <span class="tag">Service</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Smali/">
                        <span class="tag">Smali</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/TabLayout/">
                        <span class="tag">TabLayout</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/View/">
                        <span class="tag">View</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/WanANdroid/">
                        <span class="tag">WanANdroid</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/WebService/">
                        <span class="tag">WebService</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Xen/">
                        <span class="tag">Xen</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/allowBackup/">
                        <span class="tag">allowBackup</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/事件分发/">
                        <span class="tag">事件分发</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动画/">
                        <span class="tag">动画</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/四大组件/">
                        <span class="tag">四大组件</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/局域网/">
                        <span class="tag">局域网</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/布局控件/">
                        <span class="tag">布局控件</span>
                        <span class="tag is-grey">28</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/应用/">
                        <span class="tag">应用</span>
                        <span class="tag is-grey">23</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开发问题/">
                        <span class="tag">开发问题</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开机动画/">
                        <span class="tag">开机动画</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源/">
                        <span class="tag">开源</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源库/">
                        <span class="tag">开源库</span>
                        <span class="tag is-grey">24</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/微信公众号/">
                        <span class="tag">微信公众号</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/快捷键/">
                        <span class="tag">快捷键</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手电筒/">
                        <span class="tag">手电筒</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/技术选型/">
                        <span class="tag">技术选型</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/文本/">
                        <span class="tag">文本</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/框架/">
                        <span class="tag">框架</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码分析/">
                        <span class="tag">源码分析</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/百度地图/">
                        <span class="tag">百度地图</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/系统源码/">
                        <span class="tag">系统源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/终端/">
                        <span class="tag">终端</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/聚合数据/">
                        <span class="tag">聚合数据</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/自定义View/">
                        <span class="tag">自定义View</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟化/">
                        <span class="tag">虚拟化</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/译文/">
                        <span class="tag">译文</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪吃蛇/">
                        <span class="tag">贪吃蛇</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/资源/">
                        <span class="tag">资源</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/资源配置/">
                        <span class="tag">资源配置</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/辅助工具/">
                        <span class="tag">辅助工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/配置/">
                        <span class="tag">配置</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/问题/">
                        <span class="tag">问题</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="onlyloveyd" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 yidong&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>